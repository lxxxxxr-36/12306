# 12306官网复刻需求报告（PRD）

## 文档信息
- 产品名称：12306官网复刻项目
- 版本：v1.0
- 日期：2025-10-19
- 文档类型：需求报告/PRD

## 1. 项目概述
- 目标：在Web端完整复刻12306官网核心能力：注册/登录、车票查询与预订、订单与退改签、支付、个人中心、信息查询与客服、候补购票、会员积分等。
- 范围：PC网页为主，移动网页适配；APP另行规划。
- 原则：实名制购票、票务库存真实、峰值高并发可用、安全合规、可观测、可运维。
- 使用说明：参考 `web/README.md`，在 `web` 目录执行 `npm install` 后运行 `npm run dev` 启动本地开发服务并打开 `http://localhost:5173/`。

## 2. 核心功能模块与需求拆解
### 2.1 用户注册与登录（覆盖注册、登录、忘记密码）
- 页面与路由：`/login` 登录页、`/register` 注册页、`/forgot` 忘记密码页；受保护页面未登录时统一跳转 `/login` 并保留来源路径与查询参数。
- 登录方式：支持“账号登录”（用户名/手机号/邮箱 + 密码）与“扫码登录”；登录成功后建立本地会话并根据来源路径返回。
- 扫码登录：包含二维码生成、状态轮询与“模拟扫描/确认”操作；状态枚举为 `pending/scanned/confirmed/expired`；支持刷新二维码。

#### 2.1.1 用户账户注册
- 登录方式：用户名/手机号/邮箱 + 密码；不支持验证码；在当前版本不展示图形验证码；提供“忘记密码/注册”入口。
- 注册信息（9项，除邮箱外均必填）：
  1) 用户名：以字母开头，6-30位字母/数字/下划线；唯一
  2) 登录密码：≥6位
  3) 确认密码：与登录密码一致
  4) 证件类型：下拉选择（居民身份证、港澳居民居住证、台湾居民居住证、外国人永久居留身份证、外国护照、中国护照、港澳居民来往内地通行证、台湾居民来往大陆通行证）
  5) 姓名：2-30位中文/字母/间隔符“·”
  6) 证件号码：按数字位数范围宽松校验；居民身份证≥17位（最多18位），护照5-18位，其他证件8-18位；字母或符号不参与位数统计
  7) 优惠类型：成人/儿童/学生/残疾军人
  8) 邮箱：可选，合法邮箱格式
  9) 电话：区号下拉（+86 中国、+852 中国香港、+853 中国澳门、+886 中国台湾）+号码；+86需11位数字，其它区号5-20位数字
- 注册前置：勾选“我已阅读并同意《用户注册协议》”；不使用图形验证码校验。
- 注册成功后：
  - 在本地用户库写入上述信息
  - 在乘车人库初始化“本人”乘车人（含姓名、证件类型、证件号码、手机/电话、核验状态（已核验）、操作（不可删除））
  - 在受让人库初始化“本人”受让人（含姓名、证件类型、证件号码、手机、生效日期、审核状态（已通过）、操作栏为空，不可删除）
  - 旧账号首次打开“乘车人”页面时，若缺少“本人”记录则自动补全
  - 注册成功后跳转到登录页面

- 会话与权限：登录后建立会话；访问 `/orders`、`/checkout/:id`、`/my/*`、`/member` 等受保护路由需已登录。

#### 2.1.2 忘记密码
- 四步向导：填写账户信息 → 获取验证码 → 设置新密码 → 完成。
- 填写账户信息页（Step 0）：
  - 必填字段：区号（+86/+852/+853/+886）+手机号、证件类型（下拉八类：居民身份证、港澳居民居住证、台湾居民居住证、外国人永久居留身份证、外国护照、中国护照、港澳居民来往内地通行证、台湾居民来往大陆通行证）、证件号码
  - 前端校验：+86 手机号需 11 位数字，其它区号需 5-20 位数字；证件号码仅按“数字位数”宽松校验：居民身份证 17-18 位，护照 5-18 位，其它证件 8-18 位（非数字字符不参与位数统计）
  - 错误提示：提交失败或校验不通过时在表单底部以红色提示块展示
  - 提交条件：通过上述校验后，“提交”按钮可点击；提交后进入“获取验证码”页
  - 接口：validateAccountIdentity({ phoneNumber, idType, idNo })
- 获取验证码页（Step 1）：
  - 展示字段：已验证的手机号（含区号）
  - 交互：点击“发送手机验证码”后开始 120 秒倒计时；倒计时期间按钮置灰不可点；倒计时结束后按钮文案变为“重新发送验证码”
  - 验证码输入：填写短信验证码后点击“提交”进入下一步
  - 接口：requestPasswordReset({ account: phoneNumber })、verifyResetCode({ account: phoneNumber, code })
  - 有效期：验证码有效期 120 秒（超时提示“验证码已过期”）
  - 重新发送：点击“重新发送验证码”会使之前的验证码立刻失效
- 设置新密码页（Step 2）：
  - 必填字段：新密码、确认新密码
  - 规则：长度 ≥6，且需包含“字母、数字、下划线”中至少两类；两次输入需一致
  - 接口：resetPassword({ account: phoneNumber, code, newPassword })
- 完成页（Step 3）：
  - 提示：“新密码设置成功，您可以使用新密码登录系统!”
  - 操作：“登录系统”跳转 `/login`
- 接口签名：
  - validateAccountIdentity: (req: { phoneNumber: string; idType: IdType; idNo: string }) => Promise<{ ok: boolean; message?: string }>
  - requestPasswordReset: (req: { account: string }) => Promise<{ ok: boolean; message?: string; code?: string }>
  - verifyResetCode: (req: { account: string; code: string }) => Promise<{ ok: boolean; message?: string }>
  - resetPassword: (payload: { account: string; code: string; newPassword: string }) => Promise<{ ok: boolean; message?: string }>

#### 2.1.3 注册/登录页样式与交互
- 注册卡片宽度 `700px`，居中布局；表单控件统一高度与边距，标签宽度固定 `160px` 且不换行。
- 账号登录支持密码显示/隐藏切换；错误信息在按钮下方以红色提示块展示。
- 扫码登录区展示二维码占位与状态文案；提供“模拟扫描/确认/刷新二维码”按钮。
- 底部说明：展示业务办理时间提示文案。

### 2.2 首页布局（导航栏、首页查询卡片样式与交互）
- 顶部导航结构（登录态）：我的12306 | 您好，{username} | 退出。
  - 路由与跳转：
    - 我的12306 → `/my`（按钮/文本，蓝色，字号14px，悬停下拉）
    - 您好，{username} → 用户名可点击跳入个人中心 `/my`（“您好，”黑色；`{username}` 蓝色；字号14px）
    - 退出 → 点击退出登录（黑色，字号14px），返回首页
  - 分隔符：各项之间使用竖线 `|` 分隔；分隔符左右间距统一为 `8px`。

- 顶部导航结构（未登录态）： 我的12306 | 登录 | 注册。
  - 登录 → `/login`（黑色，字号14px）
  - 注册 → `/register`（黑色，字号14px）
  - 受保护路由点击会跳转登录并重定向回来源路径；
- 主导航含“首页/车票/团购/会员/站车/商旅/出行指南/信息查询”一级项与二级下拉。
- 顶部“我的12306”：点击进入 `/my`；悬停时下拉列出15项常用入口：火车票订单、候补订单、计次·定期票订单、约号订单、雪具快运订单、电子发票、本人车票、我的餐饮·特产、我的保险、我的会员、查看个人信息、账户安全、乘车人、地址管理、温馨服务查询等；未登录点击任一入口跳转 `/login` 并保留来源。
- 主导航栏交互：二级下拉采用多列栅格；悬停打开、移出关闭；点击二级项关闭下拉并导航到对应路由。
- 首页查询卡片：近似正方形；`width=420px`、`min-height=420px`、`padding=12px`；顶部为票种标签“单程/往返”，默认“单程”高亮并显示蓝色圆点图标与下划线分隔。左侧切换栏：包含“车票”（默认激活）与“常用查询”（占位）和“订餐”（占位）；激活项白底，左侧保留蓝色竖边；与右侧查询表单紧密连接无中缝。
- 默认值与参数：出发地默认“北京”、到达地默认“成都”、出发日期默认当天；往返模式显示返程日期输入，若未填则以出发日期作为默认参与查询；首页提交携带 `origin/dest/date/ticketType/returnDate?`、`hs=1|0`（默认1）、`stu=1|0`、`search=1`。（首页查询卡片点击查询后直接进入查询结果页输出查询结果），查询按钮上方“学生”与“高铁动车”两项合并同一行并居中显示。默认勾选：高铁/动车默认勾选，首页查询时 `hs=1`。
- 输入与校验：统一“标签：输入框”一行布局；标签宽度 `68px`，输入最大宽度 `<=260px`；地址与日期高度 `32px`；出发日期不得早于当天，返程不得早于出发，否则弹出错误提示，不允许提交查询；地址需在站点列表内；出发地与到达地不可相同，否则弹出错误提示，不允许提交查询。
- 城市选择与建议：地址输入点击自动选中文本并弹出 `datalist` 热门城市；选择城市覆盖当前值；支持一键调换出发/到达（右侧 22×22 圆形橙色交换按钮，带白色双向箭头）。
- 结果页入口与行为：首页查询卡提交直接跳转 `/results?search=1` 并立即查询；从主导航“车票→单程/往返”进入结果页时默认不查询（`search=0`），需手动点击“查询”或点击顶部日期标签触发；日期标签始终基于当天生成连续15天。

#### 2.2.1 顶部导航结构与交互
- 页面结构：顶部包含 `logo`、欢迎区、`我的12306` 下拉入口以及登录/注册入口。
- 登录态：显示 `您好，{用户名}`；用户名可点击进入 `/my`；提供 `退出` 按钮。
- 未登录态：显示 `登录`（跳转 `/login`）与 `注册`（跳转 `/register`）。
- 分隔符：各项之间使用 `|`，左右间距统一为 `8px`。
- `我的12306`：点击标题进入 `/my`；下拉列出常用入口（个人信息、本人车票、订单中心、乘车人、地址管理等）。

#### 2.2.2 主导航样式与交互
- 位置与样式：主导航位于头部下方，背景 `#2ea5ff`；二级下拉采用多列栅格；悬停打开、移出关闭。
- 一级项：`首页/车票/团购服务/会员服务/站车服务/商旅服务/出行指南/信息查询`。
- 下拉交互：点击任一二级项关闭下拉并导航到对应页面；带箭头指示展开状态。

#### 2.2.3 主导航二级条目与路由映射（完整）
- 车票：
  - 购买：`/results?ticketType=oneway`（单程）、`/results?ticketType=roundtrip`（往返）、`/stub/transfer`（中转换乘）
  - 变更：`/stub/refund`（退票）、`/stub/reschedule`（改签）、`/stub/change_station`（变更到站）
  - 更多：`/stub/crh_card`（中铁银通卡）、`/stub/international`（国际列车）
  - 快捷入口：`/orders`（受保护，订单中心）、`/standby`（候补购票）
- 团购服务：`/group?tab=worker`、`/group?tab=student`。
- 会员服务：`/member`（受保护）、`/membership`（专题页）。
- 站车服务：`/stub/priority_passenger`、`/stub/hand`、`/stub/ride_service`、`/stub/station_guide`、`/stub/lost`、`/stub/train_intro`、`/stub/custom_pickup`、`/stub/station_style`。
- 商旅服务：`/stub/food`、`/stub/insurance`、`/stub/ski`。
- 出行指南：`/stub/faq_ticket`、`/stub/faq_reschedule_change`、`/stub/faq_more`、`/stub/faq_buy`、`/stub/faq_refund`、`/stub/verify`、`/stub/notice_more`、`/stub/e_ticket`、`/stub/regulation_transport`、`/stub/regulation_hsr`、`/stub/regulation_more`、`/stub/regulation_items`。
- 信息查询：`/stub/ontime`、`/stub/weather`、`/stub/timetable`、`/stub/traffic`、`/stub/public_price`、`/stub/agency`、`/stub/check`、`/stub/service_number`、`/stub/sale_time`、`/stub/train_status`、`/stub/latest`、`/stub/credit`。
#### 2.2.4 验收要点（首页与导航）
- 悬停菜单显示完整的二级条目；登录/未登录点击行为正确。
- 顶部导航样式一致：字号14px、分隔符统一8px间距；“我的12306”为蓝色，其余为黑色；登录态显示“您好，用户名（蓝色） | 退出”。

### 2.3 车票购买逻辑（主要为查询结果页）
- 页面与路由：查询结果 `/results`；订单确认（新建）`/checkout/new?...`（作为 `/checkout/:id` 的 `id=new` 变体）；支付确认 `/checkout/{order_id}`；订单中心 `/orders`；候补购票 `/standby`。
- 结果页能力：支持单程/往返；顶部生成连续15天的日期标签；筛选席别与时段、车次类型（G/D），可按价格/时间排序；“仅看有票”同时隐藏距发车不足30分钟的车次。
- 售票截止与预订：当距发车不足30分钟，预订按钮置灰并提示；有票时点击“预订”进入新建订单确认页。
- 导航入口：点击“车票”下的“单程/往返”分别进入 `/results?ticketType=oneway` 或 `/results?ticketType=roundtrip`。进入查询结果页后自动填充但不搜索：
  - 出发地默认“北京”，到达地默认“成都”；出发日期默认当天；往返默认同时填充返程日期为当天。
  - URL 同步包含 `search=0`，表示未执行查询。
  - 点击出发地/目的地输入框自动选中文本并展开热门城市下拉（`popularCities`）；点击城市覆盖默认地址并保持不搜索。
  - 点击日期输入框弹出原生日历；往返模式显示出发与返程两个日期。
- 查询触发：
  - 首页查询卡提交：直接进入结果页并立即查询（URL 携带 `search=1`）。
- 查询结果页设计：
  - 搜索栏：包含票种单选（单程/往返）、出发地/到达地输入（支持热门城市建议；获得焦点自动选中文本；选择城市后更新但不立即查询）、出发日期输入（不可早于当天）、往返模式显示返程日期输入（不可早于出发日）、乘客类型单选（普通/学生）；点击“查询”进行校验并执行搜索。
  - 日期标签：始终基于当天生成连续15天；点击任意标签立即触发查询（URL 置 `search=1`），并高亮当前日期。
  - 参数同步：控件变化实时同步到 URL；从导航进入为 `search=0` 不查询；首页提交或点击日期标签会置 `search=1` 并查询。
  - 高级筛选面板：可折叠；包含
    - 车次类型（G/D，其它类型置灰不可选）
    - 出发车站/到达车站（按城市生成多站列表，支持“全选”与逐项勾选）
    - 车次席别（商务/一等/二等，支持“全部”重置；软卧/硬卧占位置灰）
  - 快捷筛选栏：席别下拉、排序（出发/到达时间、历时、价格）、发车时段（全天或分段：00-06/06-12/12-18/18-24）、车次类型芯片（G/D）、“仅看有票”“显示中转换乘”开关。
  - 列表呈现：表头为“车次/出发站-到达站/出发时间-到达时间/历时/商务座/一等座/二等座/无座/操作”；每行余票以“有/--”显示；点击车次号可展开“票价信息”，学生票按 0.9 折显示。
  - 预订与候补：各席别余票总数为 0 时显示“候补”并进入候补页；有票时显示“预订”，当距发车不足 30 分钟或出发日早于当天则按钮置灰并提示；点击“预订”进入 `/checkout/new` 并携带行程参数。
  - 中转换乘：开启“显示中转换乘”后计算最多 5 个联程候选（保证首程到达与次程出发间隔 ≥30 分钟）；点击“预订联程”将生成两笔订单、扣减对应席别库存，并跳转第一笔订单确认页。
  - “仅看有票”：过滤时同时剔除已截止售票车次（距发车不足 30 分钟）。

- 从导航栏“车票→单程/往返”进入：默认不查询（`search=0`），需手动点击“查询”或点击日期标签触发。

- 往返校验：返程日期仅需不早于出发日期（可同日）。

- 下单与库存：创建订单后按所选席别与人数扣减库存；学生票价格按 0.9 折计算；售票截止规则生效（距发车不足30分钟不可提交）。

- 数据模型摘要：订单状态为 `pending/paid/refunding/cancelled`；订单项包含 `trainCode/seatType/carriage/seatNo/price`；乘客包含 `name/idType/idNo/student`；库存按 `trainCode+seatType` 管理并支持扣减/恢复；订单分组 `groupId?` 用于往返或联程（同组两笔订单）。
- 验收要点：查询→确认（含选座）→支付闭环；学生票折扣与售票/退票截止规则生效；库存扣减与恢复一致；候补流程状态可见。
#### 2.3.1 确认订单页细节
- 路由与模式：`/checkout/:id`；`id=new` 表示新建订单确认（从结果页携带行程参数进入），`id={order_id}` 表示已有订单确认（展示订单详情与操作按钮）。
- 顶部行程摘要：显示出发日期、车次号、行程（出发站（出发时间）→到达站（到达时间））；右侧展示三类席别价格（已按是否学生折扣展示）。
- 乘客选择区：
  - 两个分组：受让人、乘车人；提供姓名搜索框；列表以多选框形式展示。
  - 不可混选：若已勾选某分组的成员，再勾选另一分组将提示“不支持混合选择”并阻止。
  - 默认行：明细表默认存在序号1的空行；首次勾选填充该行；继续勾选自动新增行。
  - 取消勾选：若取消勾选，序号1行清空字段，其余行直接删除；当所有行均无来源时，当前分组状态重置为未选择。
- 明细表：
  - 列：序号/票种（成人/学生）/席别（商务/一等/二等）/姓名/证件类型/证件号码/操作。
  - 席别选择：根据余票动态禁用对应席别；默认二等座。
  - 证件类型：默认渲染为下拉“选择证件类型”；一旦选择后转为只读文本显示。
  - 行删除：点击“×”删除当前行；序号1为清空字段，其余行为移除整行。
- 提交与校验：
  - 提交按钮位于底部居中，橙色；“上一步”返回上一页。
  - 提交条件：需至少勾选一名乘客且完成姓名与证件号码；当距发车不足30分钟或出发日期早于当天，提交按钮禁用并提示已截止售票。
- 选座弹窗：
  - 触发：点击“提交订单”后弹出；展示每位乘客的席别与可选座位字母（A/B/C/D/F）。
  - 规则：可逐人选择座位字母；不选择则随机分配；点击“返回修改”关闭弹窗并返回表格。
  - 确认：点击“确认”后为每位乘客生成订单，包含“车厢 + 座位号（两位数字 + 字母）”，并按所选席别与人数扣减库存；跳转到订单中心。
- 价格与折扣：成人按标准价，学生按 0.9 折计算；顶部摘要与票价信息处均按折扣显示。
- 已有订单确认：
  - 内容：展示订单行程、订单号、状态、车次、席别、座位（若已分配）、票价。
  - 操作：待支付显示“立即支付/取消订单/返回”；已支付显示“申请退票/返回订单中心”，距发车不足1小时不可退票（按钮置灰并提示“已截止”）；退票中显示“退票处理中…/返回订单中心”；已取消仅显示“返回订单中心”。

#### 2.3.2 订单中心与支付、退票、变更逻辑
- 页面与路由：受保护页面 `/orders`；支付确认页 `/checkout/{order_id}`。
- 列表字段：订单号/行程（含车次）/出发日期/乘客/座位/金额/状态/操作。
- 状态与操作：
  - 待支付：显示“去支付”“取消订单”，且在未发车时可“变更到站”“改签”。
  - 已支付：在未发车时可“变更到站”“改签”；满足条件可“退票”；距发车不足1小时按钮置灰提示“已截止”。
  - 退票中：显示“退票处理中…”，其余操作不可用。
- 支付与出票：
  - 从订单中心点击“去支付”跳转 `/checkout/{order_id}`；点击“立即支付”后订单状态改为“已支付”，并随机生成“车厢 + 座位号”写回订单。
  - 列表“座位”列显示为“{车厢}车厢 {座位号}”，未分配时显示“--”。
- 退票逻辑：
  - 仅限“已支付”订单；距发车不足 1 小时不允许退票（服务层按车次出发时间校验）。
  - 流程：先标记 `refunding`，退票完成后恢复对应席别余票并将订单标记为 `cancelled`。
- 变更到站逻辑：
  - 输入框支持热门城市 `datalist`；需选择有效站点，重复值不变更。
  - 允许状态：待支付或已支付且未发车；保存后更新订单到达地 `dest`。
 - 改签规则（官网对齐）：
  - 定义与次数：变更乘车日期/时间/车次/席位/席别/到站的手续；每张票仅可改签一次。
  - 受限条件：已办理“变更到站”的车票不再办理改签。
  - 办理途径：未取纸质票且不晚于开车前25分钟可在网站办理；已取纸质票或距开车不足25分钟需在窗口办理（本复刻项目仅实现网站端逻辑与提示）。
  - 时间窗口：
    - 开车前48小时（含以上）：允许改签至预售期内其他列车（本项目简化为允许改签到任意未来日期）。
    - 开车前不足48小时：允许改签到票面日期当日或更早的日期；不允许改签到票面日期之后的日期。
    - 开车后至票面日期当日24:00：仅允许同日范围；本项目仅记录“日期”，不支持时刻改签，故仅允许同日改签（等效限制）。
  - 费用规则：当不足48小时改签到票面日期之后预售期内列车将核收改签费；本项目不涉及费用结算，采用“不允许”的前端与服务层限制进行简化对齐。
 - 改签逻辑（实现）：
  - 仅支持修改出发日期（同车次同席别）；新日期不得早于当天。
  - 允许状态：待支付或已支付；依据上述时间窗口规则限制是否可改签及可选日期。
  - 次数控制：每张订单仅可改签一次（`rescheduleCount<=0`）。
  - 与到站变更的关系：已执行“变更到站”的订单不可再改签（`changeDestCount>0` 禁止）。
- 验收要点：
  - 操作按钮随订单状态与发车时间正确切换；“去支付/取消/退票/变更到站/改签”行为与校验一致。
  - 退票恢复余票；列表信息与订单详情一致；从列表“去支付”进入支付页成功。

#### 2.3.3 候补购票
- 页面与路由：页面 `/standby`；从查询结果页“候补”按钮进入将携带 `origin/dest/date/train` 参数预填。
- 登录与回跳：未登录提交时跳转 `/login` 并回跳到来源（保留行程与车次参数）。
- 表单结构：
  - 行程选择：出发地/目的地下拉（热门城市列表）、日期输入（不得早于当天）；选择后自动加载可候补车次列表并默认选中第一项。
  - 候补车次：下拉选择，展示 `车次号 出发-到达`；加载中显示“正在加载车次…”，无可候补显示“该日期暂无可候补车次，请更换日期”。
  - 乘客信息：姓名、证件类型（身份证/护照）、证件号；支持“+ 添加乘客”与删除，至少保留一名乘客。
  - 席别偏好：复选框（商务/一等/二等/无座）；至少选择一项。
  - 截止时间与优先级：候补截止（2h/6h/24h，分别对应 120/360/1440 分钟）；优先级（时间优先/价格优先）。
  - 定金展示：按每位乘客 ¥50 计算，总额至少 ¥50。
- 提交校验：
  - 必填：出发地/目的地/日期/候补车次/至少一名乘客（含姓名与证件号）/至少一个席别偏好。
  - 行程规则：出发地与目的地不可相同；出发日期不得早于当天。
  - 截止售票：距所选车次发车不足 30 分钟时不可提交候补。
- 状态与轮询：
  - 创建后初始状态为“匹配中”；系统每 1 秒轮询状态更新。
  - 状态枚举：匹配中/候补成功/已过期/已取消；成功时显示“已候补到席别：{席别}”。
  - 取消候补：仅在“匹配中”时可取消；取消后状态为“已取消”。
- 验收要点：
  - 回跳与预填参数正确；表单校验与“距发车不足30分钟”限制生效；状态在轮询中正确切换；取消候补可用；定金计算与席别偏好选择正常。

#### 2.3.4 路由与入口（补充概述）
- 路由与入口：
  - 查询结果页：`/results?origin={城市}&dest={城市}&date={YYYY-MM-DD}&search=1`。
  - 订单确认（新建）：`/checkout/new?origin={城市}&dest={城市}&date={YYYY-MM-DD}&train={车次}&stu=0|1`（来自查询页“预订”）。
  - 支付确认：`/checkout/{order_id}`（订单中心“去支付”跳转）。
- 受保护与跳转：`/checkout/:id` 与 `/orders` 为受保护路由，未登录跳转 `/login` 并保留来源路径。
- 查询结果页要点：支持发车时段、车次类型（G/D）、席别过滤与价格/时间排序；“仅看有票”同时隐藏距发车不足30分钟的车次；演示数据覆盖 0–23 点每小时至少一班高铁。
- 订单确认页（`/checkout/new`）：受让人与乘车人分组展示并支持姓名过滤；两组不可混选；每行可选择票种与席别，证件类型下拉八类；提交后弹出座位选择模态（A/B/C/D/F，未选则随机）。
- 下单与库存：确认后为每位乘客生成订单，按所选席别与人数扣减库存；学生票价格按 0.9 折；距发车不足30分钟不可提交。
- 支付与出票（`/checkout/{order_id}`）：“立即支付”完成出票并随机分配车厢与座位号；距发车不足1小时不可退票；退票成功后恢复库存并标记取消。
- 验收要点：查询→确认（含选座）→支付闭环；库存扣减与恢复一致；混选限制与截止规则生效。

### 2.4 个人中心
- 页面与路由：受保护路由 `/my/*`；侧栏包含“订单中心/本人车票/个人信息/常用信息管理/温馨服务”等分组；

- 我的12306 悬停展示15项：
  - 火车票订单（/my/orders/train）
  - 候补订单（/my/orders/waitlist）
  - 计次·定期票订单（/my/orders/timescard）
  - 约号订单（/my/orders/appointment）
  - 雪具快运订单（/my/orders/ski）
  - 电子发票（/my/orders/invoice）
  - 本人车票（/my/ticket）
  - 我的餐饮·特产（/my/orders/food）
  - 我的保险（/my/orders/insurance）
  - 我的会员（/member）
  - 查看个人信息（/my/profile/view）
  - 账户安全（/my/profile/security）
  - 乘车人（/my/common/passengers）
  - 地址管理（/my/common/addresses）
  - 温馨服务查询（/my/service/query）
- 未登录点击：跳转登录页，登录成功后重定向到来源路径（上述对应路由）。
- 已登录点击：直接跳转到对应页面。
- 直接点击“我的12306”：跳转到个人中心首页（/my）。

#### 2.4.1 个人中心首页（/my）页面结构
- 布局：左侧树状指引栏 + 右侧内容区域；左侧主分支标题加粗。
- 主分支与路由：
  - 个人中心（/my，主分支标题可点击，直接进入）
  - 订单中心（不可点击主分支，下设8项）：
    - 火车票订单（/my/orders/train）
    - 候补订单（/my/orders/waitlist）
    - 计次·定期票订单（/my/orders/timescard）
    - 约号订单（/my/orders/appointment）
    - 雪具快运订单（/my/orders/ski）
    - 餐饮·特产（/my/orders/food）
    - 保险订单（/my/orders/insurance）
    - 电子发票（/my/orders/invoice）
  - 本人车票（/my/ticket，主分支标题可点击，直接进入）
  - 会员中心（主分支标题可点击，打开独立页面 /member）
  - 个人信息（主分支不可直接点击，下设4项）：
    - 查看个人信息（/my/profile/view）
    - 账号安全（/my/profile/security）
    - 手机核验（/my/profile/mobile）
    - 账号注销（/my/profile/delete）
  - 常用信息管理（主分支不可直接点击，下设2项）：
    - 乘车人（/my/common/passengers）
    - 地址管理（/my/common/addresses）
  - 温馨服务（主分支不可直接点击，下设3项）：
    - 重点旅客预约（/my/service/priority）
    - 遗失物品查找（/my/service/lost）
    - 服务查询（/my/service/query）

- 面包屑：不显示自动面包屑；内容区顶部不展示“当前位置”。
- 链接策略：侧边栏链接统一指向绝对路径（以 `/my/` 开头），避免在子页面间点击时路径叠加。
- 受保护路由：`/orders`、`/checkout/:id`、`/my/*`、`/member`、`/station`、`/business` 等需登录访问；未登录重定向到 `/login`，并携带来源路径。
- 登录成功后返回来源路径；若无来源则返回首页。

#### 2.4.2 乘车人页面（个人中心 → 常用信息管理 → 乘车人）
- 路径：`/my/common/passengers`（需登录）
- 数据：按账户维度存储，包含本人与手动添加的乘车人；本地存储键 `passengers:{username}`
  - 旧账号进入页时自动补全本人信息（从用户资料拷贝）
- 存储字段（TypeScript）：
  - `Passenger`：`id`、`owner`、`isSelf`、`name`、`idType`、`idNo`、`phoneCode`（`'+86'|'+852'|'+853'|'+886'`）、`phoneNumber`、`benefit`、`verified`、`createdAt?`（`YYYY-MM-DD`）
  - `IdType`：八类证件类型（与注册一致）；`BenefitType`：成人/儿童/学生/残疾军人
- 列表结构：
  - 表头常驻：序号、姓名、证件类型、证件号码、手机/电话、核验状态、操作
  - 行内容：
    - 序号左侧为选择框；本人行选择框禁用，操作列为空
    - 证件号显示遮罩：前4位 + 12个“*” + 后3位
    - 手机显示遮罩：`(+区号)前三位****后四位`
    - 核验状态展示为“已核验”（绿色）
- 查询：顶部输入“请输入乘客姓名”，仅在点击“查询”时按姓名包含进行过滤；清空按钮“×”同时清除输入与过滤条件（恢复显示全部）
- 操作区：
  - “+ 添加”（绿色）：跳转至添加乘车人页（后续实现）
  - “🗑 批量删除”（红色）：
    - 若未选择任何行：全屏模态弹窗（蓝色标题栏“删除乘车人”，正文“请先选择联系人”，按钮“确定”）
    - 若已有选择：全屏模态“删除乘车人”，正文“您确定要删除选中的乘车人吗？”，按钮“取消/确定”；点击“确定”后删除并展示全屏模态“删除成功”（按钮“确定”）
  - 行内操作：
    - 垃圾桶：全屏模态“删除乘车人”确认，点击“确定”后删除并展示全屏模态“删除成功”（按钮“确定”）
    - 铅笔：跳转至编辑页面 `/my/common/passengers/edit/{id}`
- 特殊规则：本人行不可被选择，不显示行内操作；仍计入序号展示
- 验收：
  - 初始列表包含本人一行；删除操作与查询过滤行为符合描述；数据持久化正常
#### 2.4.3 添加乘车人
- 路径：`/my/common/passengers/add`（需登录）
- 分区与字段：
  - 基本信息（加粗）：
    - 证件类型（下拉，八项同注册）
    - 姓名（必填，2-30位中文/字母/“·”）
    - 证件号码（必填，按数字位数范围校验；与注册一致）
  - 联系方式：标题后括号与文字为橙色“(请提供乘车人真实有效的联系方式)”；
    - 手机号码（必填）：区号下拉（+86/+852/+853/+886）+号码；`+86`需11位数字，其它区号5-20位数字
  - 附加信息（加粗）：
    - 优惠(待)类型（必填）：成人/儿童/学生/残疾军人
- 交互：
  - 保存：校验通过后写入乘车人库并展示全屏模态“添加成功”（蓝色标题栏“添加乘车人”，按钮“确定”）；点击“确定”返回 `/my/common/passengers`；新增乘客显示在列表尾部，核验状态展示“已核验”
  - 取消：返回 `/my/common/passengers`
- 校验与规则：同注册的姓名/证件号码/电话校验（含 `+86=11位` 特例）；新增乘客 `isSelf=false`，本人不可删除的规则不变；保存时写入 `createdAt=当天(YYYY-MM-DD)`

#### 2.4.4 编辑乘车人
- 路径：`/my/common/passengers/edit/:id`（需登录）
- 页面结构：
  - 基本信息（加粗，只读）：
    - 证件类型、姓名、证件号码（遮罩显示）、国家/地区（固定显示“中国 China”）、添加日期（来自 `createdAt`，无则显示`--`）、核验状态（“已通过”）
  - 联系方式（可编辑）：
    - 手机号码（必填）：区号下拉（+86/+852/+853/+886）+号码；`+86`需11位数字，其它区号5-20位数字
  - 附加信息（可编辑）：
    - 优惠(待)类型（必填）：成人/儿童/学生/残疾军人
- 交互：
  - 保存：通过校验后更新乘车人库并返回 `/my/common/passengers`
  - 取消：返回 `/my/common/passengers`
- 特殊规则：本人乘车人不显示编辑入口；编辑页不允许修改基本信息（证件类型/姓名/证件号等）

#### 2.4.5 乘车人服务模块（本地存储实现）
- 类型：
  - `IdType`：八类证件类型（与注册一致）
  - `BenefitType`：成人/儿童/学生/残疾军人
  - `Passenger`：`id`、`owner`、`isSelf`、`name`、`idType`、`idNo`、`phoneCode`、`phoneNumber`、`benefit`、`verified`、`createdAt?`
- 存储：键名 `passengers:{owner}`；JSON序列化存取
- 方法：
  - `getPassengers(owner)`：读取列表
  - `savePassengers(owner, list)`：保存列表
  - `ensureSelfPassenger(owner, payload)`：确保本人存在；若不存在则插入，若存在则覆盖；标记 `isSelf=true`、`verified=true`，写入 `createdAt`
  - `deletePassengers(owner, ids)` / `deletePassenger(owner, id)`：删除
  - `addPassenger(owner, payload)`：新增亲友乘客；默认 `verified=true`，写入 `createdAt=当天`
  - `getPassenger(owner, id)`：按ID查询
  - `updatePassenger(owner, id, patch)`：更新联系信息与优惠类型（仅允许 `phoneCode`、`phoneNumber`、`benefit`）

#### 2.4.7 查看个人信息（个人中心 → 个人信息 → 查看个人信息）
- 路径：`/my/profile/view`（需登录）
- 数据源：本地存储用户库 `users` 中的当前用户记录（`getUserByUsername(username)`）
- 页面结构：
  - 基本信息（加粗，只读）：
    - 用户名*、姓名*、国家/地区（固定显示“中国 China”）、证件类型*、证件号码*（遮罩：前4位 + 12个“*” + 后3位）、核验状态（“已通过”，绿色）
  - 联系方式（初始只读，右侧有按钮）：
    - 展示手机号（遮罩：`(+区号)前三位****后四位`，右侧橙色文案“已通过核验”）与邮箱
    - 点击右侧“编辑”后进入可编辑态：区号下拉（+86/+852/+853/+886）+ 手机号输入 + 邮箱输入；按钮文案变为“保存”（橙底白字）
    - 保存成功后弹窗确认：“成功修改用户信息”，按钮“确定”（橙底白字）关闭
  - 附加信息（初始只读，右侧有按钮）：
    - 展示优惠(待)类型；点击“编辑”后进入可编辑态，可选择：成人/儿童/学生/残疾军人；按钮文案变为“保存”（橙底白字）
- 校验：
  - 手机号码：`+86`需11位数字；其他区号（+852/+853/+886）为5–20位数字
  - 邮箱：若填写则需匹配基本格式 `/.+@.+\..+/`
- 保存逻辑：
  - 联系方式保存：调用 `updateUserInfo(username, { phoneCode, phoneNumber, email })`
  - 附加信息保存：调用 `updateUserInfo(username, { benefit })`
  - 保存成功弹出确认对话框；失败时显示错误提示文字
  - 保存成功后立即刷新页面数据（重新读取当前用户记录），只读展示更新为最新值
- 交互说明：
  - 非编辑态下所有基本信息只读不可改；邮箱字段仅在编辑态可改
  - 编辑态下的按钮仅“保存”，点击后根据结果更新页面与弹窗提示

#### 2.4.8 用户资料更新（服务层）
- 方法：
  - `updateUserInfo(username: string, patch: Partial<{ email: string; phoneCode: '+86'|'+'852'|'+'853'|'+'886'; phoneNumber: string; benefit: BenefitType }>): Promise<{ ok: boolean; message?: string }>`
- 行为：
  - 查找用户：若不存在返回 `{ ok:false, message:'用户不存在' }`
  - 邮箱校验：若提供则需匹配 `/.+@.+\..+/`；否则允许为空（移除）
  - 手机校验：区号敏感；`+86`需11位数字，其它区号5–20位数字；两者任一提供则按组合校验后整体更新
  - 优惠类型：若提供则更新为给定枚举值
  - 持久化：写回 `users` 列表
  - 同步本人乘车人：
    - 调用 `ensureSelfPassenger(username, { fullName, idType, idNo, phoneCode, phoneNumber, benefit })` 保持本人乘车人的联系方式与优惠类型同步
  - 返回：成功 `{ ok:true }`；失败 `{ ok:false, message }`
- 其他：
  - 内部包含约150ms延时以模拟真实环境
  - 使用动态导入调用乘车人模块

#### 2.4.9 地址管理（个人中心 → 常用信息管理 → 地址管理）
- 路径：`/my/common/addresses`（需登录）
- 空列表初始展示：表头（序号/收件人/地址/手机/是否默认/操作）+ 工具栏（左侧绿色“+ 增加”按钮）+ 温馨提示块：
  1) 您最多可添加20个车票快递地址，对已支付的地址30天内不可删除与修改；
  2) 请您准确完整的填写收件地址、收件人姓名、手机号码等信息，并保持电话畅通，以免耽误接收车票。
- 列表数据结构（本地存储，键名 `addresses:{username}`）：
  - 每项字段：`id`、`receiver`、`province`、`city`、`district`、`town`、`area`、`detail`、`phone`、`isDefault`、`createdAt`
- 列表行为：
  - “设为默认/取消默认”（蓝色带下划线）：点击弹全屏模态“设置默认成功”或“取消默认成功”；设为默认后其他项`isDefault=false`
  - 行内操作：
    - 垃圾桶：弹全屏模态“您确定要删除选中的车票快递地址吗？”，按钮“取消/确定”；点击“确定”后删除并弹“删除成功”模态
    - 铅笔：进入编辑页（与添加页同样结构，填充已有数据）
- 添加/编辑页：
  - 标题：选择地址（*为必填项）
  - 所在地址（省/市/区县/乡镇（周边地区）必填，附近区域不是必填项）：省/市/区县/乡镇（周边地区）/附近区域；采用中国常见省市区样例集（见下）
  - 详细地址（必填）：输入框；右侧灰色“(地址填写规则)”鼠标悬停显示提示框：
    1) 示例地址说明；2) 依次选择示例；3) 详细地址只填楼栋与房间；4) 周边/附近按就近原则；详细地址不重复填写省市区信息
  - 收件人（必填）：2–30位中文或字母
  - 手机号（必填）：`11`位数字
  - 设为默认地址（可选）：勾选后保存即将该地址设为默认，其他项取消默认
  - 交互：取消返回列表；保存校验后写入列表并弹“添加成功/修改成功”模态，点击“确定”返回列表
- 地区选项样例集（用于联动下拉）：
  - 北京市→北京市→海淀区|朝阳区|东城区|西城区；海淀区：乡镇`学院南路/中关村街道/上地街道/青龙桥街道`，附近区域`铁科院/高铁站/商业区/科技园`
  - 上海市→上海市→浦东新区|徐汇区；浦东新区：乡镇`陆家嘴街道/张江镇/川沙新镇`，附近`陆家嘴/世博园/张江高科`
  - 广东省→广州市(天河区|越秀区)、深圳市(南山区|福田区)
  - 浙江省→杭州市(西湖区|滨江区)、宁波市(鄞州区)
  - 江苏省→南京市(鼓楼区|玄武区)、苏州市(工业园区|吴中区)
  - 四川省→成都市(武侯区|锦江区)
  - 河北省→石家庄市(长安区|桥西区)、邯郸市(丛台区|邯山区)
  - 河南省→郑州市(金水区|二七区)
  - 天津市→天津市(河东区|河西区)
- 重庆市→重庆市(渝中区|江北区)
- 组件位置说明：此页面为个人中心的“地址管理”子页

### 2.4.10 会员中心欢迎页与面包屑
- 路由：`/member`（需登录）
- 默认欢迎块：无 `sub` 参数时显示欢迎块，文案“{fullName} 先生/女士，您好! 欢迎您，铁路旅客积分网站”
- 面包屑：左侧房子图标返回 `/` 或会员入口；会员中心页面内的房子返回 `/member`，随后显示分支与子页标题。

#### 2.4.10.1 受让人管理（会员中心）
- 路由与入口：会员中心子页 `/member?sub=beneficiary`；内容区域通过查询参数 `mode` 切换子流程：列表（默认）/新增/修改/获取乘车人。
- 列表页：显示“序号/姓名/证件类型/证件号码（遮罩）/手机（遮罩）/生效日期/审核状态/操作”；本人默认作为受让人插入（不可删除），其余行显示修改与删除。
- 操作与提示：删除弹窗“确认删除 {name} 用户吗？ 取消/确认”，成功后“删除成功”；新增/修改成功均以“温馨提示 … 成功 确认”弹窗反馈。
- 新增受让人：字段包含姓名、证件类型、性别、证件号码、出生日期、手机号（区号+号码）、电子邮件；校验遵循证件号码位数规则与姓名长度；除本人外最多8人。
- 修改受让人：只读字段为姓名、证件类型、性别、证件号码、出生日期；可编辑手机号与电子邮件；保存后提示成功并返回列表。
- 从乘车人获取：数据来源为当前账户的乘车人列表；本人不可勾选；支持表头全选（排除本人）；重复受让人以弹窗提示阻止；合并后不超过8人。
- 唯一性与重复：同一账户下受让人“姓名”唯一；重复或冲突均以弹窗提示并阻止新增。
- 模式清理：在会员中心左侧切换到其他子页（如“会员须知”）时，应清理查询参数中的 `mode/id`，返回“受让人管理”时默认列表模式。
- 存储与字段：键名 `beneficiaries:{username}`；字段包含 `id/owner/name/idType/idNo/gender?/birthDate?/phoneCode?/phoneNumber?/email?/effectiveDate?/verified/createdAt`；本人受让人默认插入并标记 `verified=true`。

#### 2.4.10.2 会员须知页面
- 路由：`/member?sub=notice`（需登录）；入口：会员页“帮助中心”或会员中心左侧点击。
- 页面结构：居中标题“铁路畅行”常旅客会员服务须知；副标题说明；正文为编号条款（含子项列表）；右下角日期。
- 验收：文本与排版符合示例；返回/前进行为正常；从其他子页返回后保持在该子页。

#### 2.4.10.3 关于会员  
- 路由：`/member?sub=about_member`（需登录）；入口同上。
- 页面结构：标题“会员账户”为蓝色圆角徽章；下设“信息管理”“账户注销”两块，关键词红色强调并采用编号列表。
- 验收：文本与示例一致，红色关键词与编号样式正确；返回后保持在该子页。

#### 2.4.10.4 关于积分
- 路由：`/member?sub=about_points`（需登录）；入口同上。
- 内容分区：蓝色徽章“积分累积/积分补登/受让人/积分兑换（含兑换车票与其他规则）/会员等级”；段落关键字红色强调、编号列表展示。
- 规则提示：受让人数上限8人、积分有效期12个月、兑换资格首次需10000分、兑换比例100分=1元等说明以文本呈现。
- 验收：内容与样式正确；从其他子页返回后保持在该子页。



## 3. 业务流程
- 购票（单程/往返/联程）：
  - 发起查询：在 `/` 或 `/results` 选择出发地、到达地与日期；可选“学生票”“只看高铁动车”；“仅看有票”会隐藏距发车不足30分钟的车次。
  - 预订与确认：点击“预订”进入 `/checkout/new?...`；在确认页选择乘客（受让人/乘车人不可混选）、票种与席别；提交后进入选座模态（A/B/C/D/F），未选则随机分配。
  - 生成订单与库存：确认后为每位乘客生成订单并扣减对应席别库存；学生票按 0.9 折计价；距发车不足30分钟不可提交。
  - 支付与出票：进入 `/checkout/{order_id}` 点击“立即支付”完成出票并随机分配车厢与座位；成功后在 `/orders` 可见。
  - 退票：距发车不足1小时不可退；退票成功恢复库存并将订单状态置为已取消。
  - 改签/变更到站：在 `/orders` 可对待支付或已支付且未发车的订单执行“改签日期（不得早于今天）”与“变更到达地”。
  - 往返与联程：往返模式在查询时需提供返程日期；中转换乘在结果页选择两段车次并生成两笔关联订单。
- 候补购票：
  - 入口：`/standby`；未登录提交时先跳转 `/login` 并回跳。
  - 提交：设置行程与日期、车次、乘客、席别偏好与候补截止/优先级；定金按每位乘客 ¥50 演示。
  - 状态：`matching` → `success|expired|cancelled`；成功时选定一个席别；所有状态在本地持久化。
- 忘记密码：
  - 流程：填写账户信息（手机号、证件类型与号码）→ 发送验证码（含120秒倒计时）→ 设置新密码（需包含字母/数字/下划线中至少两种且长度≥6）→ 完成并返回登录。
  - 限制：验证码 60 秒过期；账号与证件信息需匹配。
- 登录与回跳：
  - 账号登录：用户名/邮箱/手机号 + 密码；成功后按来源路径回跳。
  - 扫码登录：二维码状态 `pending/scanned/confirmed/expired`；“模拟扫描/确认/刷新二维码”；确认后登录并回跳。
  - 受保护路由：访问 `/orders`、`/checkout/:id`、`/my/*`、`/member` 等未登录将重定向到 `/login` 并保留来源路径。

## 4. 零碎要求
- 安全与隐私：
  - 遮罩展示敏感信息：证件号显示“前4位 + 12个* + 后3位”；手机号显示“(+区号)前三位****后四位”。
  - 受保护路由与回跳：未登录访问受保护页面统一跳转至 `/login`，登录后按来源返回。
  - 本地存储隔离：用户、订单、乘车人与候补请求按账户或模块维度使用独立键名存储。
- 性能与体验：
  - 查询页筛选在前端执行；“仅看有票”同时排除距发车不足30分钟的车次。
  - 交互反馈及时：发送验证码与下单、退票等操作提供明确的成功/失败文案与禁用状态。
  - 模拟延时：查询/登录/资料更新等操作包含轻量延时以贴近真实体验。
- 兼容性与适配：
  - PC 优先：内容区最大宽度 `1200px`；主导航栅格与下拉适配。
  - 表单统一规格：输入高度一致、标签与输入同行排列；日期控件使用原生选择。
- 可观测与可运维：
  - 事件通知：订单与会话变更分别派发全局事件，便于页面联动。
  - 开发环境验证码输出：仅在本地开发时以日志方式输出验证码，生产不输出。

### 2.10 接口与集成（示例）
- GET /api/trains?origin=&dest=&date=&filters=...
- POST /api/orders (下单锁票)
- POST /api/payments (创建支付)；POST /api/payments/notify (渠道回调)
- POST /api/orders/refund；POST /api/orders/reschedule
- POST /api/waitlist；GET /api/waitlist/{id}


