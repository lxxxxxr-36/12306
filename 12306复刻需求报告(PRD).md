# 12306官网复刻需求报告（PRD）

## 文档信息
- 产品名称：12306官网复刻项目
- 版本：v1.0
- 日期：2025-10-19
- 文档类型：需求报告/PRD

## 1. 项目概述与范围
- 目标：在Web端完整复刻12306官网核心能力：注册/登录、车票查询与预订、订单与退改签、支付、个人中心、信息查询与客服、候补购票、会员积分等。
- 范围：PC网页为主，移动网页适配；APP另行规划。
- 原则：实名制购票、票务库存真实、峰值高并发可用、安全合规、可观测、可运维。

## 2. 核心功能模块与需求拆解
### 2.1 用户账户与登录
- 登录方式：用户名/手机号/邮箱 + 密码；支持验证码；风控场景下触发滑块/图形验证码；记住用户名；忘记密码/注册入口。
- 注册信息（9项，除邮箱外均必填）：
  1) 用户名：以字母开头，6-30位字母/数字/下划线；唯一
  2) 登录密码：≥6位
  3) 确认密码：与登录密码一致
  4) 证件类型：下拉选择（居民身份证、港澳居民居住证、台湾居民居住证、外国人永久居留身份证、外国护照、中国护照、港澳居民来往内地通行证、台湾居民来往大陆通行证）
  5) 姓名：2-30位中文/字母/间隔符“·”
  6) 证件号码：仅按数字位数范围校验（放宽校验）；居民身份证需≥17位数字（最多18位），护照5-18位，其他证件8-18位；字母或符号可存在但不参与位数统计
  7) 优惠类型：成人/儿童/学生/残疾军人
  8) 邮箱：可选，合法邮箱格式
  9) 电话：区号下拉（+86 中国、+852 中国香港、+853 中国澳门、+886 中国台湾）+号码；+86需11位数字，其它区号5-20位数字
- 注册前置：勾选“我已阅读并同意《用户注册协议》”；取消图形验证码（当前版本注册页不展示/不校验验证码）
- 注册成功后：
  - 在本地用户库写入上述信息
  - 在乘车人库初始化“本人”乘车人（含姓名、证件类型与号码、电话、优惠类型，标记为已核验，不可批量删除）
  - 旧账号首次打开“乘车人”页面时，若缺少“本人”记录则自动补全
- 注册与实名认证：手机号注册、短信验证；姓名+身份证号实名校验；支持添加乘车人（本人/亲友）。
- 安全：HTTPS全站、密码加密传输（TLS+前端不可逆算法+后端BCrypt/Scrypt存储）；登录失败次数限制、设备指纹与IP限流、黑名单与风险评分。
- 会话与登录态：Token+Cookie双态；有效期30分钟不操作自动退出；支持“保持登录”。

#### 忘记密码（新增）
- 四步向导：填写账户信息 → 获取验证码 → 设置新密码 → 完成。
- 账户信息：区号（+86/+852/+853/+886）+手机号、证件类型与证件号；前端校验手机号与证件号码位数。
- 获取验证码：展示手机号；点击“获取手机验证码”后开始120s倒计时；结束后按钮文案为“重新发送验证码”。
- 验证码输出：开发环境通过本地开发服务器中间件打印到终端（`npm run dev` 控制台），接口 `POST /__dev/log-code`，载荷 `{ account, code }`。
- 设置新密码：包含字母、数字、下划线中不少于两种且长度不少于6；需与确认密码一致。
- 完成页：文案“新密码设置成功，您可以使用新密码登录系统!”；“登录系统”四字蓝色可点击跳转登录，其余橙色。
- 访问权限：忘记密码流程无需登录；手机号匹配支持所有区号。

#### 注册页样式与交互（改动）
- 布局与居中：注册页容器使用 `"login-page register-page"` 类名以居中卡片，参考 `web/src/pages/Register.tsx:51`；卡片宽度调整为 `700px`，参考 `web/src/pages/login.css:12`。
- 表单尺寸统一：输入框与下拉框统一高度与边距（`box-sizing:border-box`），参考 `web/src/pages/login.css:18` 与 `web/src/pages/login.css:19`；下拉框与输入框长度完全一致，参考 `web/src/pages/login.css:41`、`web/src/pages/login.css:42`，并通过 `web/src/pages/login.css:43` 设置 `flex:1;width:auto` 等宽。
- 标签宽度与不换行：标签固定 `160px` 且不换行，避免“优惠（待）类型”换行，参考 `web/src/pages/login.css:39`。
- 字段与控件：
  - 证件类型控件位置参考 `web/src/pages/Register.tsx:68`–`web/src/pages/Register.tsx:79`。
  - 优惠（待）类型控件位置参考 `web/src/pages/Register.tsx:89`–`web/src/pages/Register.tsx:96`。
- 注册验证码取消：注册流程不展示/不校验图形验证码；页面未包含相关 import/状态/绘制逻辑（已移除）。
- 按钮文案：提交按钮文案为 `“下一步”`，参考 `web/src/pages/Register.tsx:124`。
- 提交与反馈：提交逻辑参考 `web/src/pages/Register.tsx:26`–`web/src/pages/Register.tsx:48`，保持原有校验与成功跳转行为不变。

示例样式片段（用于代码恢复）：

```css
.login-card{background:#fff;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,.08);padding:16px;width:700px;} /* web/src/pages/login.css:12 */
.form-item input{flex:1;padding:10px;border:1px solid #ccc;border-radius:4px;font-size:14px;box-sizing:border-box} /* web/src/pages/login.css:18 */
.form-item select{padding:10px;border:1px solid #ccc;border-radius:4px;font-size:14px;box-sizing:border-box} /* web/src/pages/login.css:19 */
.reg-label{width:160px;text-align:right;color:#333;font-size:14px;white-space:nowrap} /* web/src/pages/login.css:39 */
.reg-input{flex:none;width:340px} /* web/src/pages/login.css:41 */
.reg-select{width:340px} /* web/src/pages/login.css:42 */
.form-item .reg-select{flex:1;width:auto} /* web/src/pages/login.css:43 */
.register-page{display:flex !important; justify-content:center;} /* web/src/pages/login.css:46 */
```

示例页面结构片段：

```tsx
return (
  <div className="login-page register-page"> {/* web/src/pages/Register.tsx:51 */}
    <div className="login-card">
      <form className="form" onSubmit={handleSubmit}>
        <div className="form-item reg-row">
          <span className="reg-label"><span className="req">*</span> 证件类型：</span>
          <select className="reg-select" value={idType} onChange={e=>setIdType(e.target.value as IdType)}>
            {/* 选项略 */}
          </select>
        </div>
        <div className="form-item reg-row">
          <span className="reg-label"><span className="req">*</span> 优惠（待）类型：</span>
          <select className="reg-select" value={benefit} onChange={e=>setBenefit(e.target.value as BenefitType)}>
            {/* 选项略 */}
          </select>
        </div>
        <button type="submit" className="primary">下一步</button> {/* web/src/pages/Register.tsx:124 */}
      </form>
    </div>
  </div>
)
```

### 2.2 车票查询与筛选
- 查询条件：出发地/到达地/出发日期；是否学生票；是否只看高铁动车；中转/联程（可选）。
- 结果展示：车次、出发/到达时间、历时、席别（商务/一等/二等/硬座/硬卧/软卧/无座等）、票价、余票、购票按钮。
- 筛选/排序：发车时间段、车次类型（G/D/Z/T/K）、席别、是否直达、价格升降、仅显示有票（同时隐藏已截止车次，距发车不足30分钟）。
- 性能：查询接口≤2s；缓存热门线路；实时库存读取+降级机制。

### 2.3 下单与锁票
- 流程：选择车次与席别→添加乘车人→确认订单→锁票（占座）→支付。
- 乘车人规则：单次最多5人；需实名通过；儿童票/学生票规则校验。
- 锁票规则：支付时限（如15分钟）；超时自动释放；并发冲突采取乐观锁+队列顺序化。
- 座位分配：同车厢优先、靠窗/过道偏好；不可满足时给出提示。

### 2.4 候补购票（无票场景）
- 提交候补：选择目标车次与席别、可接受时间段；冻结候补资金或预授权。
- 成功回填：一旦放票或退票产生库存，系统按规则撮合；成功后通知并自动扣款出票。
- 规则：公平队列、同一用户按提交时间排序；失败解冻资金。

### 2.5 订单中心与退改签
- 订单列表：未支付/已支付/已出票/已完成/已取消/候补中；支持时间、车次筛选。
- 订单详情：车次、乘车人、座位、票价、交易流水、发票/报销凭证。
- 改签：同线路同席别、差价结算；锁票与库存校验；改签失败回退原订单。
- 退票：按铁路退票规则计算手续费；原路退款；部分乘车人退票支持。
- 发票：支持增值税电子发票申请与下载。

### 2.6 支付结算
- 支付渠道：支付宝、微信、银联云闪付、银行卡；支持二维码/跳转支付。
- 安全与对账：支付状态异步回调、幂等校验、签名验签、对账日报；重复支付防护。
- 超时与失败：支付超时关闭订单并释放座位；失败重试与切换渠道。

### 2.7 个人中心与会员
- 资料管理：头像、联系方式、收件地址；安全设置（密码、手机号绑定）。
- 乘车人管理：新增/编辑/删除；与证件类型校验。
- 会员积分：乘车积分累计与兑换（如餐饮/特产/站内服务）；积分规则与清零机制。
- 消息通知：站内信、短信、邮箱；重要事件（锁票、支付、退改签、候补成功）。

### 2.8 信息查询与客服
- 车站服务：进出站指引、换乘、行李、餐饮；公告与停运信息。
- 出行指南：购票政策、学生票、军人票、儿童票规则。
- 信息检索：时刻表、票价查询、运行区间、正晚点（如接入官方接口）。
- 客服：在线工单、常见问题、服务时间提示。

## 3. 关键业务流程
- 登录：输入凭据→风控校验→登录态下发→跳转首页/来源页。
- 查询购票：选择条件→拉取余票→筛选车次→下单锁票→支付→出票→消息通知。
- 候补购票：提交候补→排队撮合→成功扣款出票/失败解冻。
- 退改签：发起→规则校验→计算费用→锁定新票或退票→更新订单与通知。

## 4. 安全与合规
- 传输层：全站HTTPS；HSTS；TLS1.2+。
- 数据层：密码哈希（BCrypt/Scrypt）、敏感字段脱敏与加密（AES）；最小化存取。
- 风控：登录限流、IP与设备指纹、失败阈值锁定、WAF/防爬虫、验证码自适应难度。
- 业务安全：库存扣减幂等、订单状态机、支付签名验签、防重复提交。
- 合规：隐私政策、用户授权、等保合规、日志留存与审计。

## 5. 性能与高可用
- 目标SLA：99.95%（核心购票）
- 峰值并发：查询≥100k QPS、下单≥10k QPS；春运期间支持弹性扩容。
- 响应：首页≤3s、查询≤2s、下单≤2s、支付确认≤5s。
- 架构手段：读写分离、Redis缓存、席位库存内存化与消息队列、异步化与削峰、限流/降级/熔断、灰度发布与蓝绿切换、跨地域容灾RPO≤5min。

## 6. 兼容性与易用性
- 浏览器：Chrome≥80、Firefox≥78、Edge≥88、Safari≥12、IE11（基础功能）。
- 设备：PC优先，移动端响应式（≥360px）；触摸优化；Retina图。
- 适配：分辨率≥1024×768；断网重试与离线提示；无障碍（键盘可达、ARIA标签）。

## 7. 数据模型（核心实体）
- 用户(User)：id、login_name、mobile、email、password_hash、status。
- 乘车人(Passenger)：id、user_id、name、id_type、id_no、type。
- 车次(Train)：code、date、origin、destination、depart_time、arrive_time、duration、type。
- 库存(Inventory)：train_code、date、seat_type、remain、version。
- 订单(Order)：id、user_id、train_code、passengers、seat_type、amount、status。
- 支付(Payment)：order_id、channel、trade_no、status、notify_time。
- 候补(Waitlist)：id、user_id、intent、amount_freeze、status、priority。

## 8. 接口与集成（示例）
- GET /api/trains?origin=&dest=&date=&filters=...
- POST /api/orders (下单锁票)
- POST /api/payments (创建支付)；POST /api/payments/notify (渠道回调)
- POST /api/orders/refund；POST /api/orders/reschedule
- POST /api/waitlist；GET /api/waitlist/{id}

## 9. UI与交互要点
- 首页：顶部导航（车票、会员、站车服务、出行指南、信息查询），中部搜索框，右侧登录入口与扫码APP。
- 登录页：两栏布局（宣传图+登录表单）；用户名/手机号/邮箱输入、密码输入及显示切换、记住用户名、注册/忘记密码链接；错误即时提示。
- 登录页验证码：取消图形验证码（当前版本登录页不展示/不校验验证码）。
- 登录卡片尺寸：右侧登录卡片设置为正方形 420×420（容器使用 `grid-template-columns: 1fr 420px`），样式覆盖于 `web/src/pages/login.css:49`；注册页卡片宽度与布局不受影响（保留 `700px` 并通过 `register-page` 居中）。
- 查询结果页：条件回显、筛选条、车次列表、席别与余票列、购票按钮；无票显示候补入口。
- 订单中心：列表与详情页；退改签入口清晰与规则说明。

### 9.1 “我的12306”与个人中心导航（新增）
- 顶部导航结构（登录态）：首页 | 查询结果 | 订单中心 | 候补购票 | 我的12306 | 您好，{username} | 退出。
  - 路由与跳转：
    - 首页 → `/`（NavLink，黑色，字号14px）
    - 查询结果 → `/results`（NavLink，黑色，字号14px）
    - 订单中心 → `/orders`（NavLink，黑色，字号14px，受保护）
    - 候补购票 → `/standby`（NavLink，黑色，字号14px）
    - 我的12306 → `/my`（按钮/文本，蓝色，字号14px，悬停下拉）
    - 您好，{username} → 用户名可点击跳入个人中心 `/my`（“您好，”黑色；`{username}` 蓝色；字号14px）
    - 退出 → 点击退出登录（黑色，字号14px），返回首页
  - 分隔符：各项之间使用竖线 `|` 分隔；分隔符左右间距统一为 `8px`。

- 顶部导航结构（未登录态）：首页 | 查询结果 | 订单中心 | 候补购票 | 我的12306 | 登录 | 注册。
  - 登录 → `/login`（黑色，字号14px）
  - 注册 → `/register`（黑色，字号14px）
  - 受保护路由点击会跳转登录并重定向回来源路径

- 悬停展示15项：
  - 火车票订单（/my/orders/train）
  - 候补订单（/my/orders/waitlist）
  - 计次·定期票订单（/my/orders/timescard）
  - 约号订单（/my/orders/appointment）
  - 雪具快运订单（/my/orders/ski）
  - 电子发票（/my/orders/invoice）
  - 本人车票（/my/ticket）
  - 我的餐饮·特产（/my/orders/food）
  - 我的保险（/my/orders/insurance）
  - 我的会员（/member）
  - 查看个人信息（/my/profile/view）
  - 账户安全（/my/profile/security）
  - 乘车人（/my/common/passengers）
  - 地址管理（/my/common/addresses）
  - 温馨服务查询（/my/service/query）
- 未登录点击：跳转登录页，登录成功后重定向到来源路径（上述对应路由）。
- 已登录点击：直接跳转到对应页面。
- 直接点击“我的12306”：跳转到个人中心首页（/my）。

#### 顶部导航实现细节（改动）
- 组件与结构：
  - 顶部容器与布局：`web/src/App.tsx:41`–`web/src/App.tsx:64`（`.site-header`、`.wrap`、`.logo`、`<nav>`）。
  - “我的12306”下拉组件：`web/src/components/My12306Menu.tsx:25`–`web/src/components/My12306Menu.tsx:35`；菜单项定义于 `web/src/components/My12306Menu.tsx:4`–`web/src/components/My12306Menu.tsx:20`。
  - 登录态欢迎区与退出：`web/src/App.tsx:48`–`web/src/App.tsx:52`（“您好，”与用户名链接）、`web/src/App.tsx:61`（“退出”按钮）。
  - 未登录态入口：`web/src/App.tsx:53`–`web/src/App.tsx:58`（`/login`、`/register`）。
  - 分隔符使用：`web/src/App.tsx:46`、`web/src/App.tsx:55`、`web/src/App.tsx:59`（`|`）。
- 样式与规格：
  - 顶部样式：`web/src/App.css:1`–`web/src/App.css:5`（背景、边框、字号、激活态颜色）。
  - “我的12306”样式与交互：`web/src/App.css:7`–`web/src/App.css:13`；`web/src/App.css:11` 通过 `:hover` 展示 `.my-dropdown`。
  - 欢迎区/认证链接/分隔符/退出样式：`web/src/App.css:15`–`web/src/App.css:21`。
- 交互与行为：
  - 触发方式：点击“我的12306”文本进入 `/my`（`web/src/components/My12306Menu.tsx:26`）。
  - 菜单点击导航：每项 `onClick` 调用 `navigate(it.path)`（`web/src/components/My12306Menu.tsx:29`）。
  - 防止鼠标按下带来意外选中/焦点问题：`onMouseDown={(e) => e.preventDefault()}`（`web/src/components/My12306Menu.tsx:29`）。

#### 主导航实现细节（改动）
- 结构与路由：
  - 主导航容器：`web/src/App.tsx:65`–`web/src/App.tsx:223`（`.main-nav`、`.wrap`、`.nav-items`）。
  - 一级项目：`首页`（`web/src/App.tsx:68`），其余均为带下拉的 `div.nav-item.has-dropdown`。
  - 下拉内容示例：车票（`web/src/App.tsx:69`–`web/src/App.tsx:76`）、团购服务（`web/src/App.tsx:78`–`web/src/App.tsx:86`）、会员服务（`web/src/App.tsx:88`–`web/src/App.tsx:99`）、站车服务（`web/src/App.tsx:101`–`web/src/App.tsx:123`）、商旅服务（`web/src/App.tsx:125`–`web/src/App.tsx:140`）、出行指南（`web/src/App.tsx:142`–`web/src/App.tsx:187`）、信息查询（`web/src/App.tsx:189`–`web/src/App.tsx:220`）。
  - 二级内容栅格：`dd-grid dd-2/3/4/5/6`，列内 `dd-col`，标题 `dd-title`，嵌套 `dd-nested`，全宽行 `dd-fullrow` 用于“常用查询”。
- 样式与布局：
  - 主导航样式：`web/src/App.css:27`–`web/src/App.css:48`（背景色 `#2ea5ff`、栅格列数、悬浮态颜色、下拉层布局与阴影）。
  - 下拉显隐：CSS 通过 `.dropdown` 默认隐藏（`web/src/App.css:35`）与 `.dropdown.open` 显示（`web/src/App.css:34`）。
  - 箭头图标：`CaretDown` 组件定义于 `web/src/App.tsx:26`–`web/src/App.tsx:30`，样式位于 `web/src/App.css:32`。
- 交互与状态：
  - 打开状态管理：`openMenu`（`web/src/App.tsx:36`），在路由变化时自动关闭（`web/src/App.tsx:38`）。
  - 事件绑定：各 `has-dropdown` 节点通过 `onMouseEnter` 打开、`onMouseLeave` 关闭（示例见 `web/src/App.tsx:69`、`web/src/App.tsx:76` 等）。
  - 点击二级项：`NavLink` 导航且 `onClick={() => setOpenMenu(null)}` 关闭下拉（示例见 `web/src/App.tsx:72`–`web/src/App.tsx:74`）。

#### 主导航二级条目与路由映射（完整）
- 车票（参考 `web/src/App.tsx:69`–`web/src/App.tsx:76`）
  - 查询结果 → `/results`
  - 订单中心 → `/orders`
  - 候补购票 → `/standby`
- 团购服务（参考 `web/src/App.tsx:78`–`web/src/App.tsx:86`）
  - 务工人员 → `/stub/group_worker`
  - 学生团体 → `/stub/group_student`
- 会员服务（参考 `web/src/App.tsx:88`–`web/src/App.tsx:99`）
  - 会员管理 → `/stub/member_mgmt`
  - 积分账户 → `/stub/member_points`
  - 积分兑换 → `/stub/member_exchange`
  - 会员专享 → `/stub/member_exclusive`
  - 会员中心 → `/member`
- 站车服务（参考 `web/src/App.tsx:101`–`web/src/App.tsx:123`）
  - 特殊重点旅客 → `/stub/priority_passenger`
  - 便民托运 → `/stub/hand`
  - 约车服务 → `/stub/ride_service`
  - 车站引导 → `/stub/station_guide`
  - 遗失物品查找 → `/stub/lost`
  - 动车组介绍 → `/stub/train_intro`
  - 定制接送 → `/stub/custom_pickup`
  - 站车风采 → `/stub/station_style`
- 商旅服务（参考 `web/src/App.tsx:125`–`web/src/App.tsx:140`）
  - 餐饮•特产 → `/stub/food`
  - 保险 → `/stub/insurance`
  - 雪具快运 → `/stub/ski`
- 出行指南（参考 `web/src/App.tsx:142`–`web/src/App.tsx:187`）
  - 常见问题：
    - 车票 → `/stub/faq_ticket`
    - 改签、变更到站 → `/stub/faq_reschedule_change`
    - 更多>> → `/stub/faq_more`
    - 购票 → `/stub/faq_buy`
    - 退票 → `/stub/faq_refund`
  - 旅客须知：
    - 身份核验 → `/stub/verify`
    - 更多>> → `/stub/notice_more`
    - 铁路电子客票 → `/stub/e_ticket`
  - 相关章程：
    - 铁路旅客运输规程 → `/stub/regulation_transport`
    - 广深港高速铁路跨境旅客运输组织规则 → `/stub/regulation_hsr`
    - 更多>> → `/stub/regulation_more`
    - 铁路旅客禁止、限制携带和托运物品目录 → `/stub/regulation_items`
- 信息查询（参考 `web/src/App.tsx:189`–`web/src/App.tsx:220`）
  - 常用查询（标题，非链接）
  - 正晚点 → `/stub/ontime`
  - 天气 → `/stub/weather`
  - 时刻表 → `/stub/timetable`
  - 交通查询 → `/stub/traffic`
  - 公布票价 → `/stub/public_price`
  - 代售点 → `/stub/agency`
  - 检票口 → `/stub/check`
  - 客服电话 → `/stub/service_number`
  - 起售时间 → `/stub/sale_time`
  - 列车状态 → `/stub/train_status`
  - 最新发布 → `/stub/latest`
  - 信用信息 → `/stub/credit`


### 9.2 个人中心页面结构（新增）
- 布局：左侧树状指引栏 + 右侧内容区域；左侧主分支标题加粗。
- 主分支与路由：
  - 个人中心（/my，主分支标题可点击，直接进入）
  - 订单中心（不可点击主分支，下设8项）：
    - 火车票订单（/my/orders/train）
    - 候补订单（/my/orders/waitlist）
    - 计次·定期票订单（/my/orders/timescard）
    - 约号订单（/my/orders/appointment）
    - 雪具快运订单（/my/orders/ski）
    - 餐饮·特产（/my/orders/food）
    - 保险订单（/my/orders/insurance）
    - 电子发票（/my/orders/invoice）
  - 本人车票（/my/ticket，主分支标题可点击，直接进入）
  - 会员中心（主分支标题可点击，打开独立页面 /member）
  - 个人信息（主分支不可直接点击，下设4项）：
    - 查看个人信息（/my/profile/view）
    - 账号安全（/my/profile/security）
    - 手机核验（/my/profile/mobile）
    - 账号注销（/my/profile/delete）
  - 常用信息管理（主分支不可直接点击，下设2项）：
    - 乘车人（/my/common/passengers）
    - 地址管理（/my/common/addresses）
  - 温馨服务（主分支不可直接点击，下设3项）：
    - 重点旅客预约（/my/service/priority）
    - 遗失物品查找（/my/service/lost）
    - 服务查询（/my/service/query）
- 内容区域初版占位：进入任一页面展示“这是XX页面”，后续按模块填充真实功能。
 - 面包屑：不显示自动面包屑；内容区顶部不展示“当前位置”。
 - 链接策略：侧边栏链接统一指向绝对路径（以 `/my/` 开头），避免在子页面间点击时路径叠加。

### 9.3 路由与登录态（新增）
- 受保护路由：/my/* 与 /member 需登录访问；未登录重定向到 /login，并携带来源路径 state.from。
- 登录成功后返回来源路径；若无来源则返回首页。
- 组件位置：
  - 顶部入口组件：src/components/My12306Menu.tsx
  - 个人中心容器：src/pages/my/PersonalCenter.tsx（含侧边栏与内部路由）
  - 会员中心占位：src/pages/my/MemberCenter.tsx
  - 各子页面占位：src/pages/my/sections/*

### 9.4 忘记密码验证码展示（新增）
- 交互：输入账号后发送验证码，前端不显示验证码内容。
- 开发模式：将验证码通过本地开发服务器中间件输出到终端（运行 `npm run dev` 的控制台）。
- 实现：前端向 `POST /__dev/log-code` 发送账号与验证码；Vite 插件在终端打印日志。
- 生产模式：不发送该日志接口，验证码由真实短信/邮件通道下发（后续集成）。

### 9.5 验收要点（新增）
- 悬停菜单显示15项，鼠标点击各项在登录/未登录两种场景均行为正确。
- 左侧树状结构分组与加粗样式符合描述；点击各分支右侧展示占位内容。
- “会员中心”从个人中心左侧点击后打开独立页面路由。
- 浏览器后退/前进在个人中心各子页工作正常。
- 顶部导航样式一致：字号14px，分隔符统一8px间距；“我的12306”为蓝色，其余为黑色；登录态显示“您好，用户名（蓝色） | 退出”。

## 10. 运维与可观测
- 指标：QPS、RT、错误率、库存命中率、支付成功率；SLO与告警阈值。
- 日志：访问、业务、风控、审计；敏感信息脱敏。
- 发布：CI/CD、自动化测试、回滚预案；节假日冻结策略。

## 11. 里程碑与验收
- M1 原型与需求冻结；M2 核心查询与下单；M3 支付与订单中心；M4 候补与退改签；M5 安全与性能优化；M6 上线与压测验收。
- 验收：功能用例通过率≥98%，性能与SLA达标，安全扫描0高危。

---
该报告为复刻12306官网核心能力的需求蓝图，可作为架构设计、前后端开发与测试的依据。

### 9.6 购票（新增）
- 路由与入口：
  - 首页查询入口 → `/`（输入出发地/到达地/出发日期，点击“查询”跳转）
  - 查询结果页 → `/results?origin={city}&dest={city}&date={YYYY-MM-DD}&filters=...`
  - 订单确认页 → `/order/confirm/{train_code}?date={YYYY-MM-DD}`（选择乘车人与席别、确认金额）
  - 支付页 → `/pay/{order_id}`（展示倒计时与支付渠道）
- 登录态与跳转：
  - 未登录点击“购票”（进入订单确认页）或“去支付”：跳转登录页 `/login`，并携带来源路径 `state.from`；登录成功后重定向回来源路径。
  - 已登录：直接进入对应页面，流程不中断。
  - 受保护路由点击会跳转登录并重定向回来源路径（订单确认与支付页）。
- 查询结果页结构与交互：
  - 条件回显（出发地/到达地/日期/过滤条件）；筛选条（发车时段、车次类型、席别、是否直达、价格排序、仅显示有票）。
  - 车次列表：展示车次号、出发/到达时间、历时、席别与票价、余票、`购票`按钮；无票时显示 `候补` 入口。
  - 仅看有票行为：勾选后同时隐藏已截止售票（距发车不足30分钟）的车次。
  - 演示数据覆盖：保证 0–23 点每小时至少一班出发车次。
  - 性能与反馈：查询接口≤2s；错误即时提示（如网络异常、参数缺失）。
- 订单确认页结构与交互：
  - 乘车人选择（最多5人，显示实名状态与遮罩化证件/电话）；席别选择与库存校验；价格汇总（含优惠类型影响）。
  - 联系方式与同意勾选（必要时展示协议勾选）；点击“确认并锁票”后创建订单并占座，进入支付页。
  - 校验规则：
    - 乘车人：实名通过、人数≤5；儿童/学生/残疾军人规则与价差；必填字段完整。
    - 库存与并发：剩余票数校验；锁票采用乐观锁与队列顺序化；失败给出明确提示。
    - 时效：支付时限15分钟；超时自动释放座位并更新订单状态。
- 支付页结构与交互：
  - 倒计时（显示剩余支付时间）；渠道选择（支付宝/微信/云闪付/银行卡，前端模拟）；支付状态回显与错误提示。
  - 支付成功：更新订单为“已支付/已出票”，跳转订单详情；失败或超时：关闭订单并释放座位。
- 浏览器行为与可用性：
  - 后退/前进在 `/results`、`/order/confirm`、`/pay` 间工作正常；刷新不丢失关键信息（依赖路由参数与本地状态）。
- 验收要点：
  - 查询→确认→支付全链路可用；未登录在受保护路由正确重定向登录并返回来源。
  - 库存扣减与释放流程符合规则；人数/席别/价格校验正确；错误提示清晰。

### 9.7 候补购票（新增）
- 路由与入口：
  - 候补购票页 → `/standby`（可在查询无票时或顶部导航进入）。
  - 候补订单查看 → `/my/orders/waitlist`（登录后从“我的12306”菜单进入）。
- 登录态与跳转：
  - 未登录点击“提交候补”：跳转 `/login` 并携带来源路径 `state.from`；登录成功后重定向回 `/standby` 并保留已选参数。
  - 已登录：直接提交候补请求并给出反馈；
  - 受保护路由点击会跳转登录并重定向回来源路径（候补提交）。
- 页面结构与交互：
  - 顶部卡片：
    - 行程：出发地与目的地下拉选择（提供热门城市列表）；两者必填且不可相同。
    - 日期：日期选择器（最小值为当天，早于当天的传入值自动校正为当天）。
  - 下方选择区：
    - 候补车次下拉：根据 `origin/dest/date` 联动刷新，选项展示车次号与发到时刻。
    - 可选时间段：允许用户选择可接受的出发时间段（早晨/上午/下午/夜间）。
  - 规则与校验：
    - 城市必选且不可相同；日期不得早于今天。
    - 与购票一致的时间限制：距发车不足30分钟禁止提交候补。
    - 当日期为今天时，自动过滤已发车或距发车不足30分钟的车次（动态按当前时间计算）。
  - 提交流程：
    - 点击“提交候补”后，创建候补意向并进入公平队列；前端展示全屏模态反馈“候补提交成功”。
    - 资金冻结/预授权按后端策略模拟；失败自动解冻并给出提示。
  - 成功回填：一旦产生库存，系统按队列撮合并自动扣款出票；结果通过站内信/短信/邮件通知，订单中心展示状态更新。
- 浏览器行为与可用性：
  - 更改行程或日期后，车次列表自动刷新；顶部与选择区的日期保持同步。
  - 刷新不丢失选择（依赖路由参数或本地状态）；前进/后退正常。
- 验收要点：
  - 顶部行程与日期联动正常，候补车次随之刷新；提交校验包含城市必选/不可相同、日期不可早于今天、30分钟截止。
  - 未登录提交候补会跳转登录并返回来源；登录态提交成功后在“候补订单”中可查询到新记录。
### 9.8 乘车人页面（个人中心 → 常用信息管理 → 乘车人）
- 路径：`/my/common/passengers`（需登录）
- 数据：按账户维度存储，包含本人与手动添加的乘车人；本地存储键 `passengers:{username}`
  - 旧账号进入页时自动补全本人信息（从用户资料拷贝）
- 存储字段（TypeScript）：
  - `Passenger`：`id`、`owner`、`isSelf`、`name`、`idType`、`idNo`、`phoneCode`（`'+86'|'+852'|'+853'|'+886'`）、`phoneNumber`、`benefit`、`verified`、`createdAt?`（`YYYY-MM-DD`）
  - `IdType`：八类证件类型（与注册一致）；`BenefitType`：成人/儿童/学生/残疾军人
- 列表结构：
  - 表头常驻：序号、姓名、证件类型、证件号码、手机/电话、核验状态、操作
  - 行内容：
    - 序号左侧为选择框；本人行选择框禁用，操作列为空
    - 证件号显示遮罩：前4位 + 12个“*” + 后3位
    - 手机显示遮罩：`(+区号)前三位****后四位`
    - 核验状态展示为“已核验”（绿色）
- 查询：顶部输入“请输入乘客姓名”，仅在点击“查询”时按姓名包含进行过滤；清空按钮“×”同时清除输入与过滤条件（恢复显示全部）
- 操作区：
  - “+ 添加”（绿色）：跳转至添加乘车人页（后续实现）
  - “🗑 批量删除”（红色）：
    - 若未选择任何行：全屏模态弹窗（蓝色标题栏“删除乘车人”，正文“请先选择联系人”，按钮“确定”）
    - 若已有选择：全屏模态“删除乘车人”，正文“您确定要删除选中的乘车人吗？”，按钮“取消/确定”；点击“确定”后删除并展示全屏模态“删除成功”（按钮“确定”）
  - 行内操作：
    - 垃圾桶：全屏模态“删除乘车人”确认，点击“确定”后删除并展示全屏模态“删除成功”（按钮“确定”）
    - 铅笔：跳转至编辑页面 `/my/common/passengers/edit/{id}`
- 特殊规则：本人行不可被选择，不显示行内操作；仍计入序号展示
- 验收：
  - 初始列表包含本人一行；删除操作与查询过滤行为符合描述；数据持久化正常
### 9.9 添加乘车人
- 路径：`/my/common/passengers/add`（需登录）
- 分区与字段：
  - 基本信息（加粗）：
    - 证件类型（下拉，八项同注册）
    - 姓名（必填，2-30位中文/字母/“·”）
    - 证件号码（必填，按数字位数范围校验；与注册一致）
  - 联系方式：标题后括号与文字为橙色“(请提供乘车人真实有效的联系方式)”；
    - 手机号码（必填）：区号下拉（+86/+852/+853/+886）+号码；`+86`需11位数字，其它区号5-20位数字
  - 附加信息（加粗）：
    - 优惠(待)类型（必填）：成人/儿童/学生/残疾军人
- 交互：
  - 保存：校验通过后写入乘车人库并展示全屏模态“添加成功”（蓝色标题栏“添加乘车人”，按钮“确定”）；点击“确定”返回 `/my/common/passengers`；新增乘客显示在列表尾部，核验状态展示“已核验”
  - 取消：返回 `/my/common/passengers`
- 校验与规则：同注册的姓名/证件号码/电话校验（含 `+86=11位` 特例）；新增乘客 `isSelf=false`，本人不可删除的规则不变；保存时写入 `createdAt=当天(YYYY-MM-DD)`

### 9.10 编辑乘车人
- 路径：`/my/common/passengers/edit/:id`（需登录）
- 页面结构：
  - 基本信息（加粗，只读）：
    - 证件类型、姓名、证件号码（遮罩显示）、国家/地区（固定显示“中国 China”）、添加日期（来自 `createdAt`，无则显示`--`）、核验状态（“已通过”）
  - 联系方式（可编辑）：
    - 手机号码（必填）：区号下拉（+86/+852/+853/+886）+号码；`+86`需11位数字，其它区号5-20位数字
  - 附加信息（可编辑）：
    - 优惠(待)类型（必填）：成人/儿童/学生/残疾军人
- 交互：
  - 保存：通过校验后更新乘车人库并返回 `/my/common/passengers`
  - 取消：返回 `/my/common/passengers`
- 特殊规则：本人乘车人不显示编辑入口；编辑页不允许修改基本信息（证件类型/姓名/证件号等）

### 9.11 乘车人服务模块（本地存储实现）
- 模块：`src/services/passengers.ts`
- 类型：
  - `IdType`：八类证件类型（与注册一致）
  - `BenefitType`：成人/儿童/学生/残疾军人
  - `Passenger`：`id`、`owner`、`isSelf`、`name`、`idType`、`idNo`、`phoneCode`、`phoneNumber`、`benefit`、`verified`、`createdAt?`
- 存储：键名 `passengers:{owner}`；JSON序列化存取
- 方法：
  - `getPassengers(owner)`：读取列表
  - `savePassengers(owner, list)`：保存列表
  - `ensureSelfPassenger(owner, payload)`：确保本人存在；若不存在则插入，若存在则覆盖；标记 `isSelf=true`、`verified=true`，写入 `createdAt`
  - `deletePassengers(owner, ids)` / `deletePassenger(owner, id)`：删除
  - `addPassenger(owner, payload)`：新增亲友乘客；默认 `verified=true`，写入 `createdAt=当天`
  - `getPassenger(owner, id)`：按ID查询
  - `updatePassenger(owner, id, patch)`：更新联系信息与优惠类型（仅允许 `phoneCode`、`phoneNumber`、`benefit`）

### 9.12 路由补充
- `src/pages/my/PersonalCenter.tsx` 内部路由：
  - `profile/view` → 查看个人信息
  - `common/passengers` → 列表页
  - `common/passengers/add` → 添加页
  - `common/passengers/edit/:id` → 编辑页

### 9.13 查看个人信息（个人中心 → 个人信息 → 查看个人信息）
- 路径：`/my/profile/view`（需登录）
- 数据源：本地存储用户库 `users` 中的当前用户记录（`getUserByUsername(username)`）
- 页面结构：
  - 基本信息（加粗，只读）：
    - 用户名*、姓名*、国家/地区（固定显示“中国 China”）、证件类型*、证件号码*（遮罩：前4位 + 12个“*” + 后3位）、核验状态（“已通过”，绿色）
  - 联系方式（初始只读，右侧有按钮）：
    - 展示手机号（遮罩：`(+区号)前三位****后四位`，右侧橙色文案“已通过核验”）与邮箱
    - 点击右侧“编辑”后进入可编辑态：区号下拉（+86/+852/+853/+886）+ 手机号输入 + 邮箱输入；按钮文案变为“保存”（橙底白字）
    - 保存成功后弹窗确认：“成功修改用户信息”，按钮“确定”（橙底白字）关闭
  - 附加信息（初始只读，右侧有按钮）：
    - 展示优惠(待)类型；点击“编辑”后进入可编辑态，可选择：成人/儿童/学生/残疾军人；按钮文案变为“保存”（橙底白字）
- 校验：
  - 手机号码：`+86`需11位数字；其他区号（+852/+853/+886）为5–20位数字
  - 邮箱：若填写则需匹配基本格式 `/.+@.+\..+/`
- 保存逻辑：
  - 联系方式保存：调用 `updateUserInfo(username, { phoneCode, phoneNumber, email })`
  - 附加信息保存：调用 `updateUserInfo(username, { benefit })`
  - 保存成功弹出确认对话框；失败时显示错误提示文字
  - 保存成功后立即刷新页面数据（重新读取当前用户记录），只读展示更新为最新值
- 组件位置：`src/pages/my/sections/ProfileView.tsx`
- 交互说明：
  - 非编辑态下所有基本信息只读不可改；邮箱字段仅在编辑态可改
  - 编辑态下的按钮仅“保存”，点击后根据结果更新页面与弹窗提示

### 9.14 用户资料更新（服务层）
- 模块：`src/services/auth.ts`
- 方法：
  - `updateUserInfo(username: string, patch: Partial<{ email: string; phoneCode: '+86'|'+'852'|'+'853'|'+'886'; phoneNumber: string; benefit: BenefitType }>): Promise<{ ok: boolean; message?: string }>`
- 行为：
  - 查找用户：若不存在返回 `{ ok:false, message:'用户不存在' }`
  - 邮箱校验：若提供则需匹配 `/.+@.+\..+/`；否则允许为空（移除）
  - 手机校验：区号敏感；`+86`需11位数字，其它区号5–20位数字；两者任一提供则按组合校验后整体更新
  - 优惠类型：若提供则更新为给定枚举值
  - 持久化：写回 `users` 列表
  - 同步本人乘车人：
    - 调用 `ensureSelfPassenger(username, { fullName, idType, idNo, phoneCode, phoneNumber, benefit })` 保持本人乘车人的联系方式与优惠类型同步
  - 返回：成功 `{ ok:true }`；失败 `{ ok:false, message }`
- 其他：
  - 内部包含约150ms延时以模拟真实环境
  - 使用动态导入调用乘车人模块

### 9.15 地址管理（个人中心 → 常用信息管理 → 地址管理）
- 路径：`/my/common/addresses`（需登录）
- 空列表初始展示：表头（序号/收件人/地址/手机/是否默认/操作）+ 工具栏（左侧绿色“+ 增加”按钮）+ 温馨提示块：
  1) 您最多可添加20个车票快递地址，对已支付的地址30天内不可删除与修改；
  2) 请您准确完整的填写收件地址、收件人姓名、手机号码等信息，并保持电话畅通，以免耽误接收车票。
- 列表数据结构（本地存储，键名 `addresses:{username}`）：
  - 每项字段：`id`、`receiver`、`province`、`city`、`district`、`town`、`area`、`detail`、`phone`、`isDefault`、`createdAt`
- 列表行为：
  - “设为默认/取消默认”（蓝色带下划线）：点击弹全屏模态“设置默认成功”或“取消默认成功”；设为默认后其他项`isDefault=false`
  - 行内操作：
    - 垃圾桶：弹全屏模态“您确定要删除选中的车票快递地址吗？”，按钮“取消/确定”；点击“确定”后删除并弹“删除成功”模态
    - 铅笔：进入编辑页（与添加页同样结构，填充已有数据）
- 添加/编辑页：
  - 标题：选择地址（*为必填项）
  - 所在地址（必填，5级联动）：省/市/区县/乡镇（周边地区）/附近区域；采用中国常见省市区样例集（见下）
  - 详细地址（必填）：输入框；右侧灰色“(地址填写规则)”鼠标悬停显示提示框：
    1) 示例地址说明；2) 依次选择示例；3) 详细地址只填楼栋与房间；4) 周边/附近按就近原则；详细地址不重复填写省市区信息
  - 收件人（必填）：2–30位中文或字母
  - 手机号（必填）：`11`位数字
  - 设为默认地址（可选）：勾选后保存即将该地址设为默认，其他项取消默认
  - 交互：取消返回列表；保存校验后写入列表并弹“添加成功/修改成功”模态，点击“确定”返回列表
- 地区选项样例集（用于联动下拉）：
  - 北京市→北京市→海淀区|朝阳区|东城区|西城区；海淀区：乡镇`学院南路/中关村街道/上地街道/青龙桥街道`，附近区域`铁科院/高铁站/商业区/科技园`
  - 上海市→上海市→浦东新区|徐汇区；浦东新区：乡镇`陆家嘴街道/张江镇/川沙新镇`，附近`陆家嘴/世博园/张江高科`
  - 广东省→广州市(天河区|越秀区)、深圳市(南山区|福田区)
  - 浙江省→杭州市(西湖区|滨江区)、宁波市(鄞州区)
  - 江苏省→南京市(鼓楼区|玄武区)、苏州市(工业园区|吴中区)
  - 四川省→成都市(武侯区|锦江区)
  - 河北省→石家庄市(长安区|桥西区)、邯郸市(丛台区|邯山区)
  - 河南省→郑州市(金水区|二七区)
  - 天津市→天津市(河东区|河西区)
- 重庆市→重庆市(渝中区|江北区)
- 组件位置：`src/pages/my/sections/Addresses.tsx`

### 9.16 地区数据来源与结构约定（地址管理）
- 数据文件：`src/data/divisions.ts`（TS对象导出，等价于JSON结构）
- 结构：`Record<省级, Record<城市, Record<区县, { towns: string[]; areas: string[] }>>>`
- 用途：驱动“所在地址”5级联动选择（省/市/区县/乡镇（周边地区）/附近区域）
- 范围：覆盖全国所有省级行政单位（含直辖市/特别行政区/自治区）；市与区县提供典型样例数据；如需完整覆盖，可替换为官方行政区划JSON并按同结构加载
- 替换方式：将JSON转换为同结构的对象或进行按需加载后赋值给 `DIVISIONS`
