# 12306官网复刻需求报告（PRD）

## 文档信息
- 产品名称：12306官网复刻项目
- 版本：v1.0
- 日期：2025-10-19
- 文档类型：需求报告/PRD

## 1. 项目概述与范围
- 目标：在Web端完整复刻12306官网核心能力：注册/登录、车票查询与预订、订单与退改签、支付、个人中心、信息查询与客服、候补购票、会员积分等。
- 范围：PC网页为主，移动网页适配；APP另行规划。
- 原则：实名制购票、票务库存真实、峰值高并发可用、安全合规、可观测、可运维。

## 2. 核心功能模块与需求拆解
### 2.1 用户账户与登录
- 登录方式：用户名/手机号/邮箱 + 密码；支持验证码；风控场景下触发滑块/图形验证码；记住用户名；忘记密码/注册入口。
- 注册信息（9项，除邮箱外均必填）：
  1) 用户名：以字母开头，6-30位字母/数字/下划线；唯一
  2) 登录密码：≥6位
  3) 确认密码：与登录密码一致
  4) 证件类型：下拉选择（居民身份证、港澳居民居住证、台湾居民居住证、外国人永久居留身份证、外国护照、中国护照、港澳居民来往内地通行证、台湾居民来往大陆通行证）
  5) 姓名：2-30位中文/字母/间隔符“·”
  6) 证件号码：仅按数字位数范围校验（放宽校验）；居民身份证需≥17位数字（最多18位），护照5-18位，其他证件8-18位；字母或符号可存在但不参与位数统计
  7) 优惠类型：成人/儿童/学生/残疾军人
  8) 邮箱：可选，合法邮箱格式
  9) 电话：区号下拉（+86 中国、+852 中国香港、+853 中国澳门、+886 中国台湾）+号码；+86需11位数字，其它区号5-20位数字
- 注册前置：勾选“我已阅读并同意《用户注册协议》”；图形验证码校验通过
- 注册成功后：
  - 在本地用户库写入上述信息
  - 在乘车人库初始化“本人”乘车人（含姓名、证件类型与号码、电话、优惠类型，标记为已核验，不可批量删除）
  - 旧账号首次打开“乘车人”页面时，若缺少“本人”记录则自动补全
- 注册与实名认证：手机号注册、短信验证；姓名+身份证号实名校验；支持添加乘车人（本人/亲友）。
- 安全：HTTPS全站、密码加密传输（TLS+前端不可逆算法+后端BCrypt/Scrypt存储）；登录失败次数限制、设备指纹与IP限流、黑名单与风险评分。
- 会话与登录态：Token+Cookie双态；有效期30分钟不操作自动退出；支持“保持登录”。

### 2.2 车票查询与筛选
- 查询条件：出发地/到达地/出发日期；是否学生票；是否只看高铁动车；中转/联程（可选）。
- 结果展示：车次、出发/到达时间、历时、席别（商务/一等/二等/硬座/硬卧/软卧/无座等）、票价、余票、购票按钮。
- 筛选/排序：发车时间段、车次类型（G/D/Z/T/K）、席别、是否直达、价格升降、仅显示有票。
- 性能：查询接口≤2s；缓存热门线路；实时库存读取+降级机制。

### 2.3 下单与锁票
- 流程：选择车次与席别→添加乘车人→确认订单→锁票（占座）→支付。
- 乘车人规则：单次最多5人；需实名通过；儿童票/学生票规则校验。
- 锁票规则：支付时限（如15分钟）；超时自动释放；并发冲突采取乐观锁+队列顺序化。
- 座位分配：同车厢优先、靠窗/过道偏好；不可满足时给出提示。

### 2.4 候补购票（无票场景）
- 提交候补：选择目标车次与席别、可接受时间段；冻结候补资金或预授权。
- 成功回填：一旦放票或退票产生库存，系统按规则撮合；成功后通知并自动扣款出票。
- 规则：公平队列、同一用户按提交时间排序；失败解冻资金。

### 2.5 订单中心与退改签
- 订单列表：未支付/已支付/已出票/已完成/已取消/候补中；支持时间、车次筛选。
- 订单详情：车次、乘车人、座位、票价、交易流水、发票/报销凭证。
- 改签：同线路同席别、差价结算；锁票与库存校验；改签失败回退原订单。
- 退票：按铁路退票规则计算手续费；原路退款；部分乘车人退票支持。
- 发票：支持增值税电子发票申请与下载。

### 2.6 支付结算
- 支付渠道：支付宝、微信、银联云闪付、银行卡；支持二维码/跳转支付。
- 安全与对账：支付状态异步回调、幂等校验、签名验签、对账日报；重复支付防护。
- 超时与失败：支付超时关闭订单并释放座位；失败重试与切换渠道。

### 2.7 个人中心与会员
- 资料管理：头像、联系方式、收件地址；安全设置（密码、手机号绑定）。
- 乘车人管理：新增/编辑/删除；与证件类型校验。
- 会员积分：乘车积分累计与兑换（如餐饮/特产/站内服务）；积分规则与清零机制。
- 消息通知：站内信、短信、邮箱；重要事件（锁票、支付、退改签、候补成功）。

### 2.8 信息查询与客服
- 车站服务：进出站指引、换乘、行李、餐饮；公告与停运信息。
- 出行指南：购票政策、学生票、军人票、儿童票规则。
- 信息检索：时刻表、票价查询、运行区间、正晚点（如接入官方接口）。
- 客服：在线工单、常见问题、服务时间提示。

## 3. 关键业务流程
- 登录：输入凭据→风控校验→登录态下发→跳转首页/来源页。
- 查询购票：选择条件→拉取余票→筛选车次→下单锁票→支付→出票→消息通知。
- 候补购票：提交候补→排队撮合→成功扣款出票/失败解冻。
- 退改签：发起→规则校验→计算费用→锁定新票或退票→更新订单与通知。

## 4. 安全与合规
- 传输层：全站HTTPS；HSTS；TLS1.2+。
- 数据层：密码哈希（BCrypt/Scrypt）、敏感字段脱敏与加密（AES）；最小化存取。
- 风控：登录限流、IP与设备指纹、失败阈值锁定、WAF/防爬虫、验证码自适应难度。
- 业务安全：库存扣减幂等、订单状态机、支付签名验签、防重复提交。
- 合规：隐私政策、用户授权、等保合规、日志留存与审计。

## 5. 性能与高可用
- 目标SLA：99.95%（核心购票）
- 峰值并发：查询≥100k QPS、下单≥10k QPS；春运期间支持弹性扩容。
- 响应：首页≤3s、查询≤2s、下单≤2s、支付确认≤5s。
- 架构手段：读写分离、Redis缓存、席位库存内存化与消息队列、异步化与削峰、限流/降级/熔断、灰度发布与蓝绿切换、跨地域容灾RPO≤5min。

## 6. 兼容性与易用性
- 浏览器：Chrome≥80、Firefox≥78、Edge≥88、Safari≥12、IE11（基础功能）。
- 设备：PC优先，移动端响应式（≥360px）；触摸优化；Retina图。
- 适配：分辨率≥1024×768；断网重试与离线提示；无障碍（键盘可达、ARIA标签）。

## 7. 数据模型（核心实体）
- 用户(User)：id、login_name、mobile、email、password_hash、status。
- 乘车人(Passenger)：id、user_id、name、id_type、id_no、type。
- 车次(Train)：code、date、origin、destination、depart_time、arrive_time、duration、type。
- 库存(Inventory)：train_code、date、seat_type、remain、version。
- 订单(Order)：id、user_id、train_code、passengers、seat_type、amount、status。
- 支付(Payment)：order_id、channel、trade_no、status、notify_time。
- 候补(Waitlist)：id、user_id、intent、amount_freeze、status、priority。

## 8. 接口与集成（示例）
- GET /api/trains?origin=&dest=&date=&filters=...
- POST /api/orders (下单锁票)
- POST /api/payments (创建支付)；POST /api/payments/notify (渠道回调)
- POST /api/orders/refund；POST /api/orders/reschedule
- POST /api/waitlist；GET /api/waitlist/{id}

## 9. UI与交互要点
- 首页：顶部导航（车票、会员、站车服务、出行指南、信息查询），中部搜索框，右侧登录入口与扫码APP。
- 登录页：两栏布局（宣传图+登录表单）；用户名/手机号/邮箱输入、密码输入及显示切换、验证码、记住用户名、注册/忘记密码链接；错误即时提示。
- 查询结果页：条件回显、筛选条、车次列表、席别与余票列、购票按钮；无票显示候补入口。
- 订单中心：列表与详情页；退改签入口清晰与规则说明。

### 9.1 “我的12306”与个人中心导航（新增）
- 顶部导航结构（登录态）：首页 | 查询结果 | 订单中心 | 候补购票 | 我的12306 | 您好，{username} | 退出。
  - 路由与跳转：
    - 首页 → `/`（NavLink，黑色，字号14px）
    - 查询结果 → `/results`（NavLink，黑色，字号14px）
    - 订单中心 → `/orders`（NavLink，黑色，字号14px，受保护）
    - 候补购票 → `/standby`（NavLink，黑色，字号14px）
    - 我的12306 → `/my`（按钮/文本，蓝色，字号14px，悬停下拉）
    - 您好，{username} → 用户名可点击跳入个人中心 `/my`（“您好，”黑色；`{username}` 蓝色；字号14px）
    - 退出 → 点击退出登录（黑色，字号14px），返回首页
  - 分隔符：各项之间使用竖线 `|` 分隔；分隔符左右间距统一为 `8px`。

- 顶部导航结构（未登录态）：首页 | 查询结果 | 订单中心 | 候补购票 | 我的12306 | 登录 | 注册。
  - 登录 → `/login`（黑色，字号14px）
  - 注册 → `/register`（黑色，字号14px）
  - 受保护路由点击会跳转登录并重定向回来源路径

- 悬停展示15项：
  - 火车票订单（/my/orders/train）
  - 候补订单（/my/orders/waitlist）
  - 计次·定期票订单（/my/orders/timescard）
  - 约号订单（/my/orders/appointment）
  - 雪具快运订单（/my/orders/ski）
  - 电子发票（/my/orders/invoice）
  - 本人车票（/my/ticket）
  - 我的餐饮·特产（/my/orders/food）
  - 我的保险（/my/orders/insurance）
  - 我的会员（/member）
  - 查看个人信息（/my/profile/view）
  - 账户安全（/my/profile/security）
  - 乘车人（/my/common/passengers）
  - 地址管理（/my/common/addresses）
  - 温馨服务查询（/my/service/query）
- 未登录点击：跳转登录页，登录成功后重定向到来源路径（上述对应路由）。
- 已登录点击：直接跳转到对应页面。
- 直接点击“我的12306”：跳转到个人中心首页（/my）。

### 9.2 个人中心页面结构（新增）
- 布局：左侧树状指引栏 + 右侧内容区域；左侧主分支标题加粗。
- 主分支与路由：
  - 个人中心（/my，主分支标题可点击，直接进入）
  - 订单中心（不可点击主分支，下设8项）：
    - 火车票订单（/my/orders/train）
    - 候补订单（/my/orders/waitlist）
    - 计次·定期票订单（/my/orders/timescard）
    - 约号订单（/my/orders/appointment）
    - 雪具快运订单（/my/orders/ski）
    - 餐饮·特产（/my/orders/food）
    - 保险订单（/my/orders/insurance）
    - 电子发票（/my/orders/invoice）
  - 本人车票（/my/ticket，主分支标题可点击，直接进入）
  - 会员中心（主分支标题可点击，打开独立页面 /member）
  - 个人信息（主分支不可直接点击，下设4项）：
    - 查看个人信息（/my/profile/view）
    - 账号安全（/my/profile/security）
    - 手机核验（/my/profile/mobile）
    - 账号注销（/my/profile/delete）
  - 常用信息管理（主分支不可直接点击，下设2项）：
    - 乘车人（/my/common/passengers）
    - 地址管理（/my/common/addresses）
  - 温馨服务（主分支不可直接点击，下设3项）：
    - 重点旅客预约（/my/service/priority）
    - 遗失物品查找（/my/service/lost）
    - 服务查询（/my/service/query）
- 内容区域初版占位：进入任一页面展示“这是XX页面”，后续按模块填充真实功能。
 - 面包屑：不显示自动面包屑；内容区顶部不展示“当前位置”。
 - 链接策略：侧边栏链接统一指向绝对路径（以 `/my/` 开头），避免在子页面间点击时路径叠加。

### 9.3 路由与登录态（新增）
- 受保护路由：/my/* 与 /member 需登录访问；未登录重定向到 /login，并携带来源路径 state.from。
- 登录成功后返回来源路径；若无来源则返回首页。
- 组件位置：
  - 顶部入口组件：src/components/My12306Menu.tsx
  - 个人中心容器：src/pages/my/PersonalCenter.tsx（含侧边栏与内部路由）
  - 会员中心占位：src/pages/my/MemberCenter.tsx
  - 各子页面占位：src/pages/my/sections/*

### 9.5 忘记密码验证码展示（新增）
- 交互：输入账号后发送验证码，前端不显示验证码内容。
- 开发模式：将验证码通过本地开发服务器中间件输出到终端（运行 `npm run dev` 的控制台）。
- 实现：前端向 `POST /__dev/log-code` 发送账号与验证码；Vite 插件在终端打印日志。
- 生产模式：不发送该日志接口，验证码由真实短信/邮件通道下发（后续集成）。

### 9.4 验收要点（新增）
- 悬停菜单显示15项，鼠标点击各项在登录/未登录两种场景均行为正确。
- 左侧树状结构分组与加粗样式符合描述；点击各分支右侧展示占位内容。
- “会员中心”从个人中心左侧点击后打开独立页面路由。
- 浏览器后退/前进在个人中心各子页工作正常。
- 顶部导航样式一致：字号14px，分隔符统一8px间距；“我的12306”为蓝色，其余为黑色；登录态显示“您好，用户名（蓝色） | 退出”。

## 10. 运维与可观测
- 指标：QPS、RT、错误率、库存命中率、支付成功率；SLO与告警阈值。
- 日志：访问、业务、风控、审计；敏感信息脱敏。
- 发布：CI/CD、自动化测试、回滚预案；节假日冻结策略。

## 11. 里程碑与验收
- M1 原型与需求冻结；M2 核心查询与下单；M3 支付与订单中心；M4 候补与退改签；M5 安全与性能优化；M6 上线与压测验收。
- 验收：功能用例通过率≥98%，性能与SLA达标，安全扫描0高危。

---
该报告为复刻12306官网核心能力的需求蓝图，可作为架构设计、前后端开发与测试的依据。
### 9.6 乘车人页面（个人中心 → 常用信息管理 → 乘车人）
- 路径：`/my/common/passengers`（需登录）
- 数据：按账户维度存储，包含本人与手动添加的乘车人；本地存储键 `passengers:{username}`
  - 旧账号进入页时自动补全本人信息（从用户资料拷贝）
- 存储字段（TypeScript）：
  - `Passenger`：`id`、`owner`、`isSelf`、`name`、`idType`、`idNo`、`phoneCode`（`'+86'|'+852'|'+853'|'+886'`）、`phoneNumber`、`benefit`、`verified`、`createdAt?`（`YYYY-MM-DD`）
  - `IdType`：八类证件类型（与注册一致）；`BenefitType`：成人/儿童/学生/残疾军人
- 列表结构：
  - 表头常驻：序号、姓名、证件类型、证件号码、手机/电话、核验状态、操作
  - 行内容：
    - 序号左侧为选择框；本人行选择框禁用，操作列为空
    - 证件号显示遮罩：前4位 + 12个“*” + 后3位
    - 手机显示遮罩：`(+区号)前三位****后四位`
    - 核验状态展示为“已核验”（绿色）
- 查询：顶部输入“请输入乘客姓名”，仅在点击“查询”时按姓名包含进行过滤；清空按钮“×”同时清除输入与过滤条件（恢复显示全部）
- 操作区：
  - “+ 添加”（绿色）：跳转至添加乘车人页（后续实现）
  - “🗑 批量删除”（红色）：
    - 若未选择任何行：弹窗“请先选择联系人”
    - 若已有选择：弹窗“您确定要删除选中的乘车人吗？”确认后删除所选并更新存储
  - 行内操作：
    - 垃圾桶：弹窗同批量删除，确认后删除该行
    - 铅笔：跳转至编辑页面 `/my/common/passengers/edit/{id}`
- 特殊规则：本人行不可被选择，不显示行内操作；仍计入序号展示
- 验收：
  - 初始列表包含本人一行；删除操作与查询过滤行为符合描述；数据持久化正常
### 9.7 添加乘车人
- 路径：`/my/common/passengers/add`（需登录）
- 分区与字段：
  - 基本信息（加粗）：
    - 证件类型（下拉，八项同注册）
    - 姓名（必填，2-30位中文/字母/“·”）
    - 证件号码（必填，按数字位数范围校验；与注册一致）
  - 联系方式：标题后括号与文字为橙色“(请提供乘车人真实有效的联系方式)”；
    - 手机号码（必填）：区号下拉（+86/+852/+853/+886）+号码；`+86`需11位数字，其它区号5-20位数字
  - 附加信息（加粗）：
    - 优惠(待)类型（必填）：成人/儿童/学生/残疾军人
- 交互：
  - 保存：校验通过后写入乘车人库并返回 `/my/common/passengers`；新增乘客显示在列表尾部，核验状态展示“已核验”
  - 取消：返回 `/my/common/passengers`
- 校验与规则：同注册的姓名/证件号码/电话校验（含 `+86=11位` 特例）；新增乘客 `isSelf=false`，本人不可删除的规则不变；保存时写入 `createdAt=当天(YYYY-MM-DD)`

### 9.8 编辑乘车人
- 路径：`/my/common/passengers/edit/:id`（需登录）
- 页面结构：
  - 基本信息（加粗，只读）：
    - 证件类型、姓名、证件号码（遮罩显示）、国家/地区（固定显示“中国 China”）、添加日期（来自 `createdAt`，无则显示`--`）、核验状态（“已通过”）
  - 联系方式（可编辑）：
    - 手机号码（必填）：区号下拉（+86/+852/+853/+886）+号码；`+86`需11位数字，其它区号5-20位数字
  - 附加信息（可编辑）：
    - 优惠(待)类型（必填）：成人/儿童/学生/残疾军人
- 交互：
  - 保存：通过校验后更新乘车人库并返回 `/my/common/passengers`
  - 取消：返回 `/my/common/passengers`
- 特殊规则：本人乘车人不显示编辑入口；编辑页不允许修改基本信息（证件类型/姓名/证件号等）

### 9.9 乘车人服务模块（本地存储实现）
- 模块：`src/services/passengers.ts`
- 类型：
  - `IdType`：八类证件类型（与注册一致）
  - `BenefitType`：成人/儿童/学生/残疾军人
  - `Passenger`：`id`、`owner`、`isSelf`、`name`、`idType`、`idNo`、`phoneCode`、`phoneNumber`、`benefit`、`verified`、`createdAt?`
- 存储：键名 `passengers:{owner}`；JSON序列化存取
- 方法：
  - `getPassengers(owner)`：读取列表
  - `savePassengers(owner, list)`：保存列表
  - `ensureSelfPassenger(owner, payload)`：确保本人存在；若不存在则插入，若存在则覆盖；标记 `isSelf=true`、`verified=true`，写入 `createdAt`
  - `deletePassengers(owner, ids)` / `deletePassenger(owner, id)`：删除
  - `addPassenger(owner, payload)`：新增亲友乘客；默认 `verified=true`，写入 `createdAt=当天`
  - `getPassenger(owner, id)`：按ID查询
  - `updatePassenger(owner, id, patch)`：更新联系信息与优惠类型（仅允许 `phoneCode`、`phoneNumber`、`benefit`）

### 9.10 路由补充
- `src/pages/my/PersonalCenter.tsx` 内部路由：
  - `common/passengers` → 列表页
  - `common/passengers/add` → 添加页
  - `common/passengers/edit/:id` → 编辑页